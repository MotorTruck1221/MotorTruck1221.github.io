{"generatedAt":1714662151613,"generateTime":421,"contents":[{"_path":"/blog/nginx-byod","_dir":"blog","_draft":false,"_partial":false,"_locale":"","title":"Making an NGINX config for BYOD (Bring Your Own Domain)","description":"Why and how I made an NGINX config for BYOD","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"making-an-nginx-config-for-byod-bring-your-own-domain"},"children":[{"type":"text","value":"Making an NGINX config for BYOD (Bring Your Own Domain)"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"what-is-byod"},"children":[{"type":"text","value":"What is BYOD?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"BYOD or Bring your own domain is an idea or concept that allows a user to point their domain to a servers IP allowing them to use the website from said domain."}]},{"type":"element","tag":"h2","props":{"id":"the-challenges"},"children":[{"type":"text","value":"The challenges"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The server needs to throw a 403 if the domain is not in the list or database."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The server "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"must"}]},{"type":"text","value":" generate a valid SSL certificate on the fly for the domain. Why? Because we don't want to have to manually generate certificates for every domain added."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"It must be semi-easy to implement into already existing configurations."}]}]},{"type":"element","tag":"h2","props":{"id":"but-why"},"children":[{"type":"text","value":"But why?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I was asked if I had an idea of how to do it, and so I thought what the hell, let's give it a shot.\nI don't mess with Nginx configurations that much, so I thought it would be a good learning experience."}]},{"type":"element","tag":"h2","props":{"id":"the-solution"},"children":[{"type":"text","value":"The solution"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"First, I should specify that this uses "},{"type":"element","tag":"a","props":{"href":"https://openresty.org/en/","rel":["nofollow"]},"children":[{"type":"text","value":"OpenResty"}]},{"type":"text","value":" which is a bundle of Nginx and LuaJIT. This is allows us to use Lua in our Nginx configuration."}]},{"type":"element","tag":"pre","props":{"className":"language-nginx shiki shiki-themes catppuccin-frappe","code":"resolver 8.8.8.8 ipv6=off;\nlua_shared_dict acme 16m;\nlua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;\nlua_ssl_verify_depth 2;\ninit_by_lua_block {\n    require(\"resty.acme.autossl\").init({\n        tos_accepted = true,\n        account_key_path = \"/etc/openresty/account.key\",\n        account_email = \"youremail@yourdomain.com\",\n        domain_whitelist = nil,\n        blocking = true,\n        -- remove in production\n        staging = true,\n    })\n}\n\ninit_worker_by_lua_block {\n    require(\"resty.acme.autossl\").init_worker()\n}\n\nserver {\n    #listen 80 default_server;\n    #listen [::]:80 default_server;\n    listen 443 ssl;\n    listen [::]:443 ssl;\n    server_name yourmainserver.com;\n    ssl_certificate /etc/openresty/default.pem;\n    ssl_certificate_key /etc/openresty/default.key;\n    ssl_certificate_by_lua_block {\n        require(\"resty.acme.autossl\").ssl_certificate()\n    } \n    location / {\n        access_by_lua_block {\n            local res = ngx.location.capture(\"/domainCheck/?domain=\" .. ngx.escape_uri(ngx.var.host))\n            if res.status ~= 200 then\n                ngx.log(ngx.WARN, \"Domain not allowed: \", ngx.var.host)\n                return ngx.exit(ngx.HTTP_FORBIDDEN)\n            end\n        }\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'Upgrade';\n        proxy_connect_timeout 10;\n        proxy_send_timeout 90;\n        proxy_read_timeout 90;\n        proxy_buffer_size 128k;\n        proxy_buffers 4 256k;\n        proxy_busy_buffers_size 256k;\n        proxy_temp_file_write_size 256k;\n        proxy_pass http://localhost:9292; # Your actual website (ex: http://localhost:3000)\n    }\n    location /.well-known {\n        access_by_lua_block {\n            local res = ngx.location.capture(\"/domainCheck/?domain=\" .. ngx.escape_uri(ngx.var.host))\n            if res.status ~= 200 then\n                ngx.log(ngx.WARN, \"Domain not allowed: \", ngx.var.host)\n                return ngx.exit(ngx.HTTP_FORBIDDEN)\n            end\n        }\n        content_by_lua_block {\n            require(\"resty.acme.autossl\").serve_http_challenge()\n        }\n    }\n    location /domainCheck {\n        internal;\n        proxy_pass http://localhost:9292/domainCheck;  # Adjust the URL if needed\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n","language":"nginx","meta":"","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"resolver "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"8.8.8.8"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" ipv6=off"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"lua_shared_dict"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" acme "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"16m"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"lua_ssl_trusted_certificate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" /etc/ssl/certs/ca-certificates.crt"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"lua_ssl_verify_depth"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":" 2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"init_by_lua_block"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    require"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"\"resty.acme.autossl\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"init"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"({\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        tos_accepted "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E78284"},"children":[{"type":"text","value":" true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        account_key_path "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":" \"/etc/openresty/account.key\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        account_email "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":" \"youremail@yourdomain.com\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        domain_whitelist "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E78284"},"children":[{"type":"text","value":" nil"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        blocking "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E78284"},"children":[{"type":"text","value":" true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#737994;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"        -- remove in production\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        staging "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#E78284"},"children":[{"type":"text","value":" true"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"    })\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"init_worker_by_lua_block"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    require"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"\"resty.acme.autossl\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"init_worker"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"server"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#737994;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    #listen 80 default_server;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#737994;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"    #listen [::]:80 default_server;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    listen "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"443"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" ssl"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    listen "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"[::]:443 ssl"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    server_name "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"yourmainserver.com"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    ssl_certificate "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"/etc/openresty/default.pem"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    ssl_certificate_key "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"/etc/openresty/default.key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    ssl_certificate_by_lua_block"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"        require"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"\"resty.acme.autossl\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"ssl_certificate"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"    } \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    location"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" / {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        access_by_lua_block"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"            local"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" res "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" ngx.location."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"capture"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"\"/domainCheck/?domain=\" "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":".."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" ngx."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"escape_uri"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"(ngx.var.host))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"            if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" res.status "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"~="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":" 200"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":" then\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"                ngx."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"log"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"(ngx.WARN, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"\"Domain not allowed: \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":", ngx.var.host)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"                return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" ngx."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"exit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"(ngx.HTTP_FORBIDDEN)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"            end\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_set_header "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"Upgrade $http_upgrade"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_set_header "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"Connection "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"'Upgrade'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_connect_timeout "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"10"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_send_timeout "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"90"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_read_timeout "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"90"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_buffer_size "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"128k"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_buffers "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":" 256k"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_busy_buffers_size "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"256k"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_temp_file_write_size "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":"256k"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_pass "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"http://localhost:9292"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#737994;--shiki-default-font-style:italic"},"children":[{"type":"text","value":" # Your actual website (ex: http://localhost:3000)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    location"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" /.well-known {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        access_by_lua_block"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"            local"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" res "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" ngx.location."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"capture"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"\"/domainCheck/?domain=\" "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":".."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" ngx."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"escape_uri"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"(ngx.var.host))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"            if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" res.status "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#81C8BE"},"children":[{"type":"text","value":"~="}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#EF9F76"},"children":[{"type":"text","value":" 200"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":" then\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"                ngx."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"log"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"(ngx.WARN, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"\"Domain not allowed: \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":", ngx.var.host)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"                return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" ngx."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"exit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"(ngx.HTTP_FORBIDDEN)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"            end\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        content_by_lua_block"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":60},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"            require"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#A6D189"},"children":[{"type":"text","value":"\"resty.acme.autossl\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":")."}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#8CAAEE;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"serve_http_challenge"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":61},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":62},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":63},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"    location"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":" /domainCheck {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":64},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        internal"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":65},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_pass "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"http://localhost:9292/domainCheck"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#737994;--shiki-default-font-style:italic"},"children":[{"type":"text","value":"  # Adjust the URL if needed\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":66},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_set_header "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"Host $host"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":67},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_set_header "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"X-Real-IP $remote_addr"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":68},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_set_header "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"X-Forwarded-For $proxy_add_x_forwarded_for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":69},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#CA9EE6"},"children":[{"type":"text","value":"        proxy_set_header "}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"X-Forwarded-Proto $scheme"}]},{"type":"element","tag":"span","props":{"style":"--shiki-default:#949CBB"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":70},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":71},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-default:#C6D0F5"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"explanation"},"children":[{"type":"text","value":"Explanation"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This configuration is a bit complex, but I'll try to explain it as best as I can."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The following directives were copied and pasted from the "},{"type":"element","tag":"a","props":{"href":"https://github.com/fffonion/lua-resty-acme","rel":["nofollow"]},"children":[{"type":"text","value":"lua-resty-acme repo"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"resolver: This is the DNS resolver used to resolve the domain."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"lua_shared_dict: This is used to store the certificates."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"lua_ssl_trusted_certificate: This is used to verify the Let's Encrypt API."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"lua_ssl_verify_depth: This is used to verify the Let's Encrypt API."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"init_by_lua_block"}]},{"type":"text","value":" is used to initialize the Let's Encrypt API. This is where you can set the email, domain whitelist, and other settings."},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"tos_accepted: This is used to accept the Let's Encrypt TOS."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"account_key_path: This is the path to your account key."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"account_email: This is the email used to register the account."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"domain_whitelist: This is the list of domains that are allowed (set to nil as we will check this in the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"location /"}]},{"type":"text","value":" block)."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"blocking: This is used to block the request until the certificate is generated. This could be set to false, but I felt like it was better to immediatley use the generated SSL certificate instead of using the fallbacks."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"staging: This is used to use the Let's Encrypt staging API. This is useful for testing and should be removed in production."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"init_worker_by_lua_block"}]},{"type":"text","value":" is used to initialize the worker. This is where the certificate is generated."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"server"}]},{"type":"text","value":" block is where the actual server configuration is. This is where the domain is checked and the ACME http challenge is served."},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"listen"}]},{"type":"text","value":" directives are used to listen on port 443 and 80."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"server_name"}]},{"type":"text","value":" directive is used to specify the main server name."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssl_certificate"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssl_certificate_key"}]},{"type":"text","value":" directives are used to specify the default certificate and key. This is used to serve the default certificate until the certificate is generated."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"ssl_certificate_by_lua_block"}]},{"type":"text","value":" is used to generate the SSL certificate."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"location /"}]},{"type":"text","value":" block is used to check if the domain is allowed. If it is not, it will return a 403.\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"access_by_lua_block"}]},{"type":"text","value":" is used to check if the domain is allowed.\n"},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"We first capture the response from the "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"/domainCheck"}]},{"type":"text","value":" location."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If the status is not 200, we log a warning and return a 403."}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"location /domainCheck"}]},{"type":"text","value":" block is used to check if the domain is allowed.\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"internal"}]},{"type":"text","value":" directive is used to prevent direct access to the location."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"proxy_pass"}]},{"type":"text","value":" directive is used to pass the request to our actual http server that verifies the domain against a database or list. If it is allowed, it sends a 200 status code."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"proxy_set_header"}]},{"type":"text","value":" directives are used to set the headers."}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"location /.well-known"}]},{"type":"text","value":" block is used to serve the ACME http challenge.\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"We also check if the domain is allowed here as to not spam the Let's Encrypt API."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"content_by_lua_block"}]},{"type":"text","value":" is used to serve the ACME http challenge."}]}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"how-i-figured-it-out"},"children":[{"type":"text","value":"How I figured it out"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"I first started with the config provided by the "},{"type":"element","tag":"a","props":{"href":"https://docs.titaniumnetwork.org/guides/nginx","rel":["nofollow"]},"children":[{"type":"text","value":"TitaniumNetwork Docs"}]},{"type":"text","value":".\nThen I started looking at how to get the domain from the request and how to check if it was allowed.\nI was using normal NGINX, but I soon realized that I needed to use Lua to get the domain and check if it was allowed.\nI then found the "},{"type":"element","tag":"a","props":{"href":"https://github.com/auto-ssl/lua-resty-auto-ssl/","rel":["nofollow"]},"children":[{"type":"text","value":"lua-resty-auto-ssl repo"}]},{"type":"text","value":" but noticed it was unmaintained and kept searching.\nThen I found the "},{"type":"element","tag":"a","props":{"href":"https://github.com/fffonion/lua-resty-acme","rel":["nofollow"]},"children":[{"type":"text","value":"lua-resty-acme repo"}]},{"type":"text","value":" and started using that.\nThe rest was trial and error with a shit ton of Googling."}]},{"type":"element","tag":"h2","props":{"id":"final-thoughts"},"children":[{"type":"text","value":"Final thoughts"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"This was a rather fun challenge, allowing me to learn crap tons of stuff about how NGINX and OpenResty works all while having fun doing so.\nThe repo providing a Discord bot, http server, database and this config is located "},{"type":"element","tag":"a","props":{"href":"https://github.com/ruby-network/byod-bot","rel":["nofollow"]},"children":[{"type":"text","value":"here"}]}]},{"type":"element","tag":"h2","props":{"id":"credits"},"children":[{"type":"text","value":"Credits:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://docs.titaniumnetwork.org","rel":["nofollow"]},"children":[{"type":"text","value":"TitaniumNetwork Docs"}]},{"type":"text","value":" for the base config."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"a","props":{"href":"https://github.com/fffonion/lua-resty-acme","rel":["nofollow"]},"children":[{"type":"text","value":"lua resty acme repo"}]},{"type":"text","value":" for the auto ssl stuff."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://caddyserver.com/docs/automatic-https#on-demand-tls","rel":["nofollow"]},"children":[{"type":"text","value":"On Demand TLS feature by Caddy"}]},{"type":"text","value":", which was an inspiration for this project."}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"what-is-byod","depth":2,"text":"What is BYOD?"},{"id":"the-challenges","depth":2,"text":"The challenges"},{"id":"but-why","depth":2,"text":"But why?"},{"id":"the-solution","depth":2,"text":"The solution"},{"id":"explanation","depth":2,"text":"Explanation"},{"id":"how-i-figured-it-out","depth":2,"text":"How I figured it out"},{"id":"final-thoughts","depth":2,"text":"Final thoughts"},{"id":"credits","depth":2,"text":"Credits:"}]}},"_type":"markdown","_id":"content:blog:nginx-byod.md","_source":"content","_file":"blog/nginx-byod.md","_extension":"md"}],"navigation":[{"title":"Blog","_path":"/blog","children":[{"title":"Making an NGINX config for BYOD (Bring Your Own Domain)","_path":"/blog/nginx-byod","description":"Why and how I made an NGINX config for BYOD"}]}]}