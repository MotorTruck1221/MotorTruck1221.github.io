{"documentCount":9,"nextId":9,"documentIds":{"0":"/blog/nginx-byod#making-an-nginx-config-for-byod-bring-your-own-domain","1":"/blog/nginx-byod#what-is-byod","2":"/blog/nginx-byod#the-challenges","3":"/blog/nginx-byod#but-why","4":"/blog/nginx-byod#the-solution","5":"/blog/nginx-byod#explanation","6":"/blog/nginx-byod#how-i-figured-it-out","7":"/blog/nginx-byod#final-thoughts","8":"/blog/nginx-byod#credits"},"fieldIds":{"title":0,"content":1,"titles":2},"fieldLength":{"0":[11,1,1],"1":[4,27,11],"2":[2,45,11],"3":[3,37,11],"4":[2,26,11],"5":[1,151,11],"6":[5,57,11],"7":[2,38,11],"8":[2,27,11]},"averageFieldLength":[3.5555555555555554,45.44444444444444,9.88888888888889],"storedFields":{"0":{"title":"Making an NGINX config for BYOD (Bring Your Own Domain)","content":"","titles":[]},"1":{"title":"What is BYOD?","content":"BYOD or Bring your own domain is an idea or concept that allows a user to point their domain to a servers IP allowing them to use the website from said domain.","titles":["Making an NGINX config for BYOD (Bring Your Own Domain)"]},"2":{"title":"The challenges","content":"The server needs to throw a 403 if the domain is not in the list or database.  The server   must  generate a valid SSL certificate on the fly for the domain. Why? Because we don't want to have to manually generate certificates for every domain added.  It must be semi-easy to implement into already existing configurations.","titles":["Making an NGINX config for BYOD (Bring Your Own Domain)"]},"3":{"title":"But why?","content":"I was asked if I had an idea of how to do it, and so I thought what the hell, let's give it a shot.\nI don't mess with Nginx configurations that much, so I thought it would be a good learning experience.","titles":["Making an NGINX config for BYOD (Bring Your Own Domain)"]},"4":{"title":"The solution","content":"First, I should specify that this uses   OpenResty  which is a bundle of Nginx and LuaJIT. This is allows us to use Lua in our Nginx configuration.","titles":["Making an NGINX config for BYOD (Bring Your Own Domain)"]},"5":{"title":"Explanation","content":"This configuration is a bit complex, but I'll try to explain it as best as I can.The following directives were copied and pasted from the   lua-resty-acme repo   resolver: This is the DNS resolver used to resolve the domain.  lua_shared_dict: This is used to store the certificates.  lua_ssl_trusted_certificate: This is used to verify the Let's Encrypt API.  lua_ssl_verify_depth: This is used to verify the Let's Encrypt API.  The    is used to initialize the Let's Encrypt API. This is where you can set the email, domain whitelist, and other settings.   tos_accepted: This is used to accept the Let's Encrypt TOS.  account_key_path: This is the path to your account key.  account_email: This is the email used to register the account.  domain_whitelist: This is the list of domains that are allowed (set to nil as we will check this in the    block).  blocking: This is used to block the request until the certificate is generated. This could be set to false, but I felt like it was better to immediatley use the generated SSL certificate instead of using the fallbacks.  staging: This is used to use the Let's Encrypt staging API. This is useful for testing and should be removed in production.  The    is used to initialize the worker. This is where the certificate is generated.  The    block is where the actual server configuration is. This is where the domain is checked and the ACME http challenge is served.   The    directives are used to listen on port 443 and 80.  The    directive is used to specify the main server name.  The    and    directives are used to specify the default certificate and key. This is used to serve the default certificate until the certificate is generated.  The    is used to generate the SSL certificate.  The    block is used to check if the domain is allowed. If it is not, it will return a 403.\n   The    is used to check if the domain is allowed.\n   We first capture the response from the    location.  If the status is not 200, we log a warning and return a 403.  The    block is used to check if the domain is allowed.\n   The    directive is used to prevent direct access to the location.  The    directive is used to pass the request to our actual http server that verifies the domain against a database or list. If it is allowed, it sends a 200 status code.  The    directives are used to set the headers.  The    block is used to serve the ACME http challenge.\n   We also check if the domain is allowed here as to not spam the Let's Encrypt API.  The    is used to serve the ACME http challenge.","titles":["Making an NGINX config for BYOD (Bring Your Own Domain)"]},"6":{"title":"How I figured it out","content":"I first started with the config provided by the   TitaniumNetwork Docs .\nThen I started looking at how to get the domain from the request and how to check if it was allowed.\nI was using normal NGINX, but I soon realized that I needed to use Lua to get the domain and check if it was allowed.\nI then found the   lua-resty-auto-ssl repo  but noticed it was unmaintained and kept searching.\nThen I found the   lua-resty-acme repo  and started using that.\nThe rest was trial and error with a shit ton of Googling.","titles":["Making an NGINX config for BYOD (Bring Your Own Domain)"]},"7":{"title":"Final thoughts","content":"This was a rather fun challenge, allowing me to learn crap tons of stuff about how NGINX and OpenResty works all while having fun doing so.\nThe repo providing a Discord bot, http server, database and this config is located   here","titles":["Making an NGINX config for BYOD (Bring Your Own Domain)"]},"8":{"title":"Credits:","content":"TitaniumNetwork Docs  for the base config.  The   lua resty acme repo  for the auto ssl stuff.   On Demand TLS feature by Caddy , which was an inspiration for this project.","titles":["Making an NGINX config for BYOD (Bring Your Own Domain)"]}},"dirtCount":0,"index":[["rather",{"1":{"7":1}}],["realized",{"1":{"6":1}}],["return",{"1":{"5":2}}],["removed",{"1":{"5":1}}],["request",{"1":{"5":2,"6":1}}],["register",{"1":{"5":1}}],["rest",{"1":{"6":1}}],["resty",{"1":{"5":1,"6":2,"8":1}}],["response",{"1":{"5":1}}],["resolve",{"1":{"5":1}}],["resolver",{"1":{"5":2}}],["repo",{"1":{"5":1,"6":2,"7":1,"8":1}}],["kept",{"1":{"6":1}}],["key",{"1":{"5":3}}],["200",{"1":{"5":2}}],["80",{"1":{"5":1}}],["443",{"1":{"5":1}}],["403",{"1":{"2":1,"5":2}}],["unmaintained",{"1":{"6":1}}],["until",{"1":{"5":2}}],["using",{"1":{"5":1,"6":2}}],["us",{"1":{"4":1}}],["useful",{"1":{"5":1}}],["used",{"1":{"5":23}}],["uses",{"1":{"4":1}}],["use",{"1":{"1":1,"4":1,"5":2,"6":1}}],["user",{"1":{"1":1}}],["you",{"1":{"5":1}}],["your",{"0":{"0":1},"1":{"1":1,"5":1},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["verifies",{"1":{"5":1}}],["verify",{"1":{"5":3}}],["valid",{"1":{"2":1}}],["project",{"1":{"8":1}}],["providing",{"1":{"7":1}}],["provided",{"1":{"6":1}}],["production",{"1":{"5":1}}],["prevent",{"1":{"5":1}}],["port",{"1":{"5":1}}],["point",{"1":{"1":1}}],["pass",{"1":{"5":1}}],["pasted",{"1":{"5":1}}],["path",{"1":{"5":2}}],["googling",{"1":{"6":1}}],["good",{"1":{"3":1}}],["get",{"1":{"6":2}}],["generated",{"1":{"5":4}}],["generate",{"1":{"2":2,"5":1}}],["give",{"1":{"3":1}}],["located",{"1":{"7":1}}],["location",{"1":{"5":2}}],["looking",{"1":{"6":1}}],["log",{"1":{"5":1}}],["like",{"1":{"5":1}}],["listen",{"1":{"5":1}}],["list",{"1":{"2":1,"5":2}}],["ll",{"1":{"5":1}}],["lua",{"1":{"4":1,"5":4,"6":3,"8":1}}],["luajit",{"1":{"4":1}}],["learn",{"1":{"7":1}}],["learning",{"1":{"3":1}}],["let",{"1":{"3":1,"5":6}}],["here",{"1":{"5":1,"7":1}}],["headers",{"1":{"5":1}}],["hell",{"1":{"3":1}}],["http",{"1":{"5":4,"7":1}}],["how",{"0":{"6":1},"1":{"3":1,"6":2,"7":1}}],["having",{"1":{"7":1}}],["have",{"1":{"2":1}}],["had",{"1":{"3":1}}],["error",{"1":{"6":1}}],["email",{"1":{"5":3}}],["encrypt",{"1":{"5":6}}],["explain",{"1":{"5":1}}],["explanation",{"0":{"5":1}}],["experience",{"1":{"3":1}}],["existing",{"1":{"2":1}}],["easy",{"1":{"2":1}}],["every",{"1":{"2":1}}],["me",{"1":{"7":1}}],["mess",{"1":{"3":1}}],["much",{"1":{"3":1}}],["must",{"1":{"2":2}}],["main",{"1":{"5":1}}],["manually",{"1":{"2":1}}],["making",{"0":{"0":1},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["demand",{"1":{"8":1}}],["default",{"1":{"5":2}}],["depth",{"1":{"5":1}}],["discord",{"1":{"7":1}}],["direct",{"1":{"5":1}}],["directive",{"1":{"5":3}}],["directives",{"1":{"5":4}}],["dict",{"1":{"5":1}}],["dns",{"1":{"5":1}}],["doing",{"1":{"7":1}}],["docs",{"1":{"6":1,"8":1}}],["do",{"1":{"3":1}}],["don",{"1":{"2":1,"3":1}}],["domains",{"1":{"5":1}}],["domain",{"0":{"0":1},"1":{"1":3,"2":3,"5":9,"6":2},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["database",{"1":{"2":1,"5":1,"7":1}}],["needed",{"1":{"6":1}}],["needs",{"1":{"2":1}}],["normal",{"1":{"6":1}}],["noticed",{"1":{"6":1}}],["not",{"1":{"2":1,"5":3}}],["name",{"1":{"5":1}}],["nil",{"1":{"5":1}}],["nginx",{"0":{"0":1},"1":{"3":1,"4":2,"6":1,"7":1},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["credits",{"0":{"8":1}}],["crap",{"1":{"7":1}}],["caddy",{"1":{"8":1}}],["capture",{"1":{"5":1}}],["can",{"1":{"5":2}}],["challenge",{"1":{"5":3,"7":1}}],["challenges",{"0":{"2":1}}],["checked",{"1":{"5":1}}],["check",{"1":{"5":5,"6":2}}],["code",{"1":{"5":1}}],["could",{"1":{"5":1}}],["copied",{"1":{"5":1}}],["complex",{"1":{"5":1}}],["concept",{"1":{"1":1}}],["configuration",{"1":{"4":1,"5":2}}],["configurations",{"1":{"2":1,"3":1}}],["config",{"0":{"0":1},"1":{"6":1,"7":1,"8":1},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["certificates",{"1":{"2":1,"5":1}}],["certificate",{"1":{"2":1,"5":8}}],["spam",{"1":{"5":1}}],["specify",{"1":{"4":1,"5":2}}],["stuff",{"1":{"7":1,"8":1}}],["started",{"1":{"6":3}}],["status",{"1":{"5":2}}],["staging",{"1":{"5":2}}],["store",{"1":{"5":1}}],["shit",{"1":{"6":1}}],["shared",{"1":{"5":1}}],["should",{"1":{"4":1,"5":1}}],["shot",{"1":{"3":1}}],["s",{"1":{"3":1,"5":6}}],["soon",{"1":{"6":1}}],["solution",{"0":{"4":1}}],["so",{"1":{"3":2,"7":1}}],["searching",{"1":{"6":1}}],["sends",{"1":{"5":1}}],["serve",{"1":{"5":3}}],["served",{"1":{"5":1}}],["server",{"1":{"2":2,"5":3,"7":1}}],["servers",{"1":{"1":1}}],["settings",{"1":{"5":1}}],["set",{"1":{"5":4}}],["semi",{"1":{"2":1}}],["ssl",{"1":{"2":1,"5":4,"6":1,"8":1}}],["said",{"1":{"1":1}}],["feature",{"1":{"8":1}}],["felt",{"1":{"5":1}}],["fun",{"1":{"7":2}}],["final",{"0":{"7":1}}],["figured",{"0":{"6":1}}],["first",{"1":{"4":1,"5":1,"6":1}}],["fallbacks",{"1":{"5":1}}],["false",{"1":{"5":1}}],["found",{"1":{"6":2}}],["following",{"1":{"5":1}}],["for",{"0":{"0":1},"1":{"2":2,"5":1,"8":3},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["fly",{"1":{"2":1}}],["from",{"1":{"1":1,"5":2,"6":1}}],["works",{"1":{"7":1}}],["worker",{"1":{"5":1}}],["would",{"1":{"3":1}}],["will",{"1":{"5":2}}],["with",{"1":{"3":1,"6":2}}],["warning",{"1":{"5":1}}],["was",{"1":{"3":1,"5":1,"6":5,"7":1,"8":1}}],["want",{"1":{"2":1}}],["were",{"1":{"5":1}}],["we",{"1":{"2":1,"5":4}}],["website",{"1":{"1":1}}],["while",{"1":{"7":1}}],["whitelist",{"1":{"5":2}}],["which",{"1":{"4":1,"8":1}}],["where",{"1":{"5":4}}],["why",{"0":{"3":1},"1":{"2":1}}],["what",{"0":{"1":1},"1":{"3":1}}],["tls",{"1":{"8":1}}],["titaniumnetwork",{"1":{"6":1,"8":1}}],["testing",{"1":{"5":1}}],["trial",{"1":{"6":1}}],["trusted",{"1":{"5":1}}],["try",{"1":{"5":1}}],["t",{"1":{"2":1,"3":1}}],["this",{"1":{"4":2,"5":18,"7":2,"8":1}}],["thoughts",{"0":{"7":1}}],["thought",{"1":{"3":2}}],["throw",{"1":{"2":1}}],["then",{"1":{"6":3}}],["the",{"0":{"2":1,"4":1},"1":{"1":1,"2":6,"3":1,"5":59,"6":8,"7":1,"8":3}}],["them",{"1":{"1":1}}],["their",{"1":{"1":1}}],["that",{"1":{"1":1,"3":1,"4":1,"5":2,"6":2}}],["tons",{"1":{"7":1}}],["ton",{"1":{"6":1}}],["tos",{"1":{"5":2}}],["to",{"1":{"1":3,"2":4,"3":1,"4":1,"5":31,"6":4,"7":1}}],["about",{"1":{"7":1}}],["auto",{"1":{"6":1,"8":1}}],["at",{"1":{"6":1}}],["against",{"1":{"5":1}}],["are",{"1":{"5":4}}],["actual",{"1":{"5":2}}],["access",{"1":{"5":1}}],["accept",{"1":{"5":1}}],["accepted",{"1":{"5":1}}],["account",{"1":{"5":4}}],["acme",{"1":{"5":4,"6":1,"8":1}}],["api",{"1":{"5":5}}],["as",{"1":{"5":4}}],["asked",{"1":{"3":1}}],["all",{"1":{"7":1}}],["allowed",{"1":{"5":6,"6":2}}],["allowing",{"1":{"1":1,"7":1}}],["allows",{"1":{"1":1,"4":1}}],["also",{"1":{"5":1}}],["already",{"1":{"2":1}}],["added",{"1":{"2":1}}],["a",{"1":{"1":2,"2":2,"3":2,"4":1,"5":6,"6":1,"7":2}}],["and",{"1":{"3":1,"4":1,"5":8,"6":5,"7":2}}],["an",{"0":{"0":1},"1":{"1":1,"3":1,"8":1},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["immediatley",{"1":{"5":1}}],["implement",{"1":{"2":1}}],["i",{"0":{"6":1},"1":{"3":5,"4":1,"5":3,"6":7}}],["it",{"0":{"6":1},"1":{"2":1,"3":3,"5":6,"6":3}}],["inspiration",{"1":{"8":1}}],["instead",{"1":{"5":1}}],["initialize",{"1":{"5":2}}],["into",{"1":{"2":1}}],["in",{"1":{"2":1,"4":1,"5":2}}],["if",{"1":{"2":1,"3":1,"5":7,"6":2}}],["ip",{"1":{"1":1}}],["idea",{"1":{"1":1,"3":1}}],["is",{"0":{"1":1},"1":{"1":1,"2":1,"4":2,"5":41,"7":1}}],["out",{"0":{"6":1}}],["our",{"1":{"4":1,"5":1}}],["other",{"1":{"5":1}}],["openresty",{"1":{"4":1,"7":1}}],["of",{"1":{"3":1,"4":1,"5":2,"6":1,"7":1}}],["on",{"1":{"2":1,"5":1,"8":1}}],["or",{"1":{"1":2,"2":1,"5":1}}],["own",{"0":{"0":1},"1":{"1":1},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["base",{"1":{"8":1}}],["bot",{"1":{"7":1}}],["by",{"1":{"6":1,"8":1}}],["byod",{"0":{"0":1,"1":1},"1":{"1":1},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}],["blocking",{"1":{"5":1}}],["block",{"1":{"5":6}}],["bit",{"1":{"5":1}}],["bundle",{"1":{"4":1}}],["but",{"0":{"3":1},"1":{"5":2,"6":2}}],["better",{"1":{"5":1}}],["best",{"1":{"5":1}}],["be",{"1":{"2":1,"3":1,"5":2}}],["because",{"1":{"2":1}}],["bring",{"0":{"0":1},"1":{"1":1},"2":{"1":1,"2":1,"3":1,"4":1,"5":1,"6":1,"7":1,"8":1}}]],"serializationVersion":2}