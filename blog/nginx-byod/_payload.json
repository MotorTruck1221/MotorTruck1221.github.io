[{"data":1,"prerenderedAt":1829},["Reactive",2],{"content-query-uxqjqCxGNs":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":9,"body":10,"_type":1824,"_id":1825,"_source":1826,"_file":1827,"_extension":1828},"/blog/nginx-byod","blog",false,"","Making an NGINX config for BYOD (Bring Your Own Domain)","Why and how I made an NGINX config for BYOD",{"type":11,"children":12,"toc":1814},"root",[13,21,25,32,38,44,72,78,83,89,105,1396,1402,1407,1709,1715,1745,1751,1763,1769,1808],{"type":14,"tag":15,"props":16,"children":18},"element","h1",{"id":17},"making-an-nginx-config-for-byod-bring-your-own-domain",[19],{"type":20,"value":8},"text",{"type":14,"tag":22,"props":23,"children":24},"hr",{},[],{"type":14,"tag":26,"props":27,"children":29},"h2",{"id":28},"what-is-byod",[30],{"type":20,"value":31},"What is BYOD?",{"type":14,"tag":33,"props":34,"children":35},"p",{},[36],{"type":20,"value":37},"BYOD or Bring your own domain is an idea or concept that allows a user to point their domain to a servers IP allowing them to use the website from said domain.",{"type":14,"tag":26,"props":39,"children":41},{"id":40},"the-challenges",[42],{"type":20,"value":43},"The challenges",{"type":14,"tag":45,"props":46,"children":47},"ul",{},[48,54,67],{"type":14,"tag":49,"props":50,"children":51},"li",{},[52],{"type":20,"value":53},"The server needs to throw a 403 if the domain is not in the list or database.",{"type":14,"tag":49,"props":55,"children":56},{},[57,59,65],{"type":20,"value":58},"The server ",{"type":14,"tag":60,"props":61,"children":62},"em",{},[63],{"type":20,"value":64},"must",{"type":20,"value":66}," generate a valid SSL certificate on the fly for the domain. Why? Because we don't want to have to manually generate certificates for every domain added.",{"type":14,"tag":49,"props":68,"children":69},{},[70],{"type":20,"value":71},"It must be semi-easy to implement into already existing configurations.",{"type":14,"tag":26,"props":73,"children":75},{"id":74},"but-why",[76],{"type":20,"value":77},"But why?",{"type":14,"tag":33,"props":79,"children":80},{},[81],{"type":20,"value":82},"I was asked if I had an idea of how to do it, and so I thought what the hell, let's give it a shot.\nI don't mess with Nginx configurations that much, so I thought it would be a good learning experience.",{"type":14,"tag":26,"props":84,"children":86},{"id":85},"the-solution",[87],{"type":20,"value":88},"The solution",{"type":14,"tag":33,"props":90,"children":91},{},[92,94,103],{"type":20,"value":93},"First, I should specify that this uses ",{"type":14,"tag":95,"props":96,"children":100},"a",{"href":97,"rel":98},"https://openresty.org/en/",[99],"nofollow",[101],{"type":20,"value":102},"OpenResty",{"type":20,"value":104}," which is a bundle of Nginx and LuaJIT. This is allows us to use Lua in our Nginx configuration.",{"type":14,"tag":106,"props":107,"children":111},"pre",{"className":108,"code":109,"language":110,"meta":7,"style":7},"language-nginx shiki shiki-themes catppuccin-mocha","resolver 8.8.8.8 ipv6=off;\nlua_shared_dict acme 16m;\nlua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;\nlua_ssl_verify_depth 2;\ninit_by_lua_block {\n    require(\"resty.acme.autossl\").init({\n        tos_accepted = true,\n        account_key_path = \"/etc/openresty/account.key\",\n        account_email = \"youremail@yourdomain.com\",\n        domain_whitelist = nil,\n        blocking = true,\n        -- remove in production\n        staging = true,\n    })\n}\n\ninit_worker_by_lua_block {\n    require(\"resty.acme.autossl\").init_worker()\n}\n\nserver {\n    #listen 80 default_server;\n    #listen [::]:80 default_server;\n    listen 443 ssl;\n    listen [::]:443 ssl;\n    server_name yourmainserver.com;\n    ssl_certificate /etc/openresty/default.pem;\n    ssl_certificate_key /etc/openresty/default.key;\n    ssl_certificate_by_lua_block {\n        require(\"resty.acme.autossl\").ssl_certificate()\n    } \n    location / {\n        access_by_lua_block {\n            local res = ngx.location.capture(\"/domainCheck/?domain=\" .. ngx.escape_uri(ngx.var.host))\n            if res.status ~= 200 then\n                ngx.log(ngx.WARN, \"Domain not allowed: \", ngx.var.host)\n                return ngx.exit(ngx.HTTP_FORBIDDEN)\n            end\n        }\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'Upgrade';\n        proxy_connect_timeout 10;\n        proxy_send_timeout 90;\n        proxy_read_timeout 90;\n        proxy_buffer_size 128k;\n        proxy_buffers 4 256k;\n        proxy_busy_buffers_size 256k;\n        proxy_temp_file_write_size 256k;\n        proxy_pass http://localhost:9292; # Your actual website (ex: http://localhost:3000)\n    }\n    location /.well-known {\n        access_by_lua_block {\n            local res = ngx.location.capture(\"/domainCheck/?domain=\" .. ngx.escape_uri(ngx.var.host))\n            if res.status ~= 200 then\n                ngx.log(ngx.WARN, \"Domain not allowed: \", ngx.var.host)\n                return ngx.exit(ngx.HTTP_FORBIDDEN)\n            end\n        }\n        content_by_lua_block {\n            require(\"resty.acme.autossl\").serve_http_challenge()\n        }\n    }\n    location /domainCheck {\n        internal;\n        proxy_pass http://localhost:9292/domainCheck;  # Adjust the URL if needed\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n","nginx",[112],{"type":14,"tag":113,"props":114,"children":115},"code",{"__ignoreMap":7},[116,146,169,187,205,219,255,281,303,325,347,368,378,399,408,417,427,440,470,478,486,499,508,517,540,557,575,593,611,624,654,663,677,690,747,776,805,828,837,846,864,886,904,922,939,957,980,998,1015,1039,1048,1061,1073,1121,1145,1169,1189,1197,1205,1218,1248,1256,1264,1277,1290,1312,1329,1346,1363,1380,1388],{"type":14,"tag":117,"props":118,"children":121},"span",{"class":119,"line":120},"line",1,[122,128,134,140],{"type":14,"tag":117,"props":123,"children":125},{"style":124},"--shiki-default:#CBA6F7",[126],{"type":20,"value":127},"resolver ",{"type":14,"tag":117,"props":129,"children":131},{"style":130},"--shiki-default:#FAB387",[132],{"type":20,"value":133},"8.8.8.8",{"type":14,"tag":117,"props":135,"children":137},{"style":136},"--shiki-default:#CDD6F4",[138],{"type":20,"value":139}," ipv6=off",{"type":14,"tag":117,"props":141,"children":143},{"style":142},"--shiki-default:#9399B2",[144],{"type":20,"value":145},";\n",{"type":14,"tag":117,"props":147,"children":149},{"class":119,"line":148},2,[150,155,160,165],{"type":14,"tag":117,"props":151,"children":152},{"style":124},[153],{"type":20,"value":154},"lua_shared_dict",{"type":14,"tag":117,"props":156,"children":157},{"style":136},[158],{"type":20,"value":159}," acme ",{"type":14,"tag":117,"props":161,"children":162},{"style":130},[163],{"type":20,"value":164},"16m",{"type":14,"tag":117,"props":166,"children":167},{"style":142},[168],{"type":20,"value":145},{"type":14,"tag":117,"props":170,"children":172},{"class":119,"line":171},3,[173,178,183],{"type":14,"tag":117,"props":174,"children":175},{"style":124},[176],{"type":20,"value":177},"lua_ssl_trusted_certificate",{"type":14,"tag":117,"props":179,"children":180},{"style":136},[181],{"type":20,"value":182}," /etc/ssl/certs/ca-certificates.crt",{"type":14,"tag":117,"props":184,"children":185},{"style":142},[186],{"type":20,"value":145},{"type":14,"tag":117,"props":188,"children":190},{"class":119,"line":189},4,[191,196,201],{"type":14,"tag":117,"props":192,"children":193},{"style":124},[194],{"type":20,"value":195},"lua_ssl_verify_depth",{"type":14,"tag":117,"props":197,"children":198},{"style":130},[199],{"type":20,"value":200}," 2",{"type":14,"tag":117,"props":202,"children":203},{"style":142},[204],{"type":20,"value":145},{"type":14,"tag":117,"props":206,"children":208},{"class":119,"line":207},5,[209,214],{"type":14,"tag":117,"props":210,"children":211},{"style":124},[212],{"type":20,"value":213},"init_by_lua_block",{"type":14,"tag":117,"props":215,"children":216},{"style":136},[217],{"type":20,"value":218}," {\n",{"type":14,"tag":117,"props":220,"children":222},{"class":119,"line":221},6,[223,229,234,240,245,250],{"type":14,"tag":117,"props":224,"children":226},{"style":225},"--shiki-default:#89B4FA;--shiki-default-font-style:italic",[227],{"type":20,"value":228},"    require",{"type":14,"tag":117,"props":230,"children":231},{"style":136},[232],{"type":20,"value":233},"(",{"type":14,"tag":117,"props":235,"children":237},{"style":236},"--shiki-default:#A6E3A1",[238],{"type":20,"value":239},"\"resty.acme.autossl\"",{"type":14,"tag":117,"props":241,"children":242},{"style":136},[243],{"type":20,"value":244},").",{"type":14,"tag":117,"props":246,"children":247},{"style":225},[248],{"type":20,"value":249},"init",{"type":14,"tag":117,"props":251,"children":252},{"style":136},[253],{"type":20,"value":254},"({\n",{"type":14,"tag":117,"props":256,"children":258},{"class":119,"line":257},7,[259,264,270,276],{"type":14,"tag":117,"props":260,"children":261},{"style":136},[262],{"type":20,"value":263},"        tos_accepted ",{"type":14,"tag":117,"props":265,"children":267},{"style":266},"--shiki-default:#94E2D5",[268],{"type":20,"value":269},"=",{"type":14,"tag":117,"props":271,"children":273},{"style":272},"--shiki-default:#F38BA8",[274],{"type":20,"value":275}," true",{"type":14,"tag":117,"props":277,"children":278},{"style":136},[279],{"type":20,"value":280},",\n",{"type":14,"tag":117,"props":282,"children":284},{"class":119,"line":283},8,[285,290,294,299],{"type":14,"tag":117,"props":286,"children":287},{"style":136},[288],{"type":20,"value":289},"        account_key_path ",{"type":14,"tag":117,"props":291,"children":292},{"style":266},[293],{"type":20,"value":269},{"type":14,"tag":117,"props":295,"children":296},{"style":236},[297],{"type":20,"value":298}," \"/etc/openresty/account.key\"",{"type":14,"tag":117,"props":300,"children":301},{"style":136},[302],{"type":20,"value":280},{"type":14,"tag":117,"props":304,"children":306},{"class":119,"line":305},9,[307,312,316,321],{"type":14,"tag":117,"props":308,"children":309},{"style":136},[310],{"type":20,"value":311},"        account_email ",{"type":14,"tag":117,"props":313,"children":314},{"style":266},[315],{"type":20,"value":269},{"type":14,"tag":117,"props":317,"children":318},{"style":236},[319],{"type":20,"value":320}," \"youremail@yourdomain.com\"",{"type":14,"tag":117,"props":322,"children":323},{"style":136},[324],{"type":20,"value":280},{"type":14,"tag":117,"props":326,"children":328},{"class":119,"line":327},10,[329,334,338,343],{"type":14,"tag":117,"props":330,"children":331},{"style":136},[332],{"type":20,"value":333},"        domain_whitelist ",{"type":14,"tag":117,"props":335,"children":336},{"style":266},[337],{"type":20,"value":269},{"type":14,"tag":117,"props":339,"children":340},{"style":272},[341],{"type":20,"value":342}," nil",{"type":14,"tag":117,"props":344,"children":345},{"style":136},[346],{"type":20,"value":280},{"type":14,"tag":117,"props":348,"children":350},{"class":119,"line":349},11,[351,356,360,364],{"type":14,"tag":117,"props":352,"children":353},{"style":136},[354],{"type":20,"value":355},"        blocking ",{"type":14,"tag":117,"props":357,"children":358},{"style":266},[359],{"type":20,"value":269},{"type":14,"tag":117,"props":361,"children":362},{"style":272},[363],{"type":20,"value":275},{"type":14,"tag":117,"props":365,"children":366},{"style":136},[367],{"type":20,"value":280},{"type":14,"tag":117,"props":369,"children":371},{"class":119,"line":370},12,[372],{"type":14,"tag":117,"props":373,"children":375},{"style":374},"--shiki-default:#6C7086;--shiki-default-font-style:italic",[376],{"type":20,"value":377},"        -- remove in production\n",{"type":14,"tag":117,"props":379,"children":381},{"class":119,"line":380},13,[382,387,391,395],{"type":14,"tag":117,"props":383,"children":384},{"style":136},[385],{"type":20,"value":386},"        staging ",{"type":14,"tag":117,"props":388,"children":389},{"style":266},[390],{"type":20,"value":269},{"type":14,"tag":117,"props":392,"children":393},{"style":272},[394],{"type":20,"value":275},{"type":14,"tag":117,"props":396,"children":397},{"style":136},[398],{"type":20,"value":280},{"type":14,"tag":117,"props":400,"children":402},{"class":119,"line":401},14,[403],{"type":14,"tag":117,"props":404,"children":405},{"style":136},[406],{"type":20,"value":407},"    })\n",{"type":14,"tag":117,"props":409,"children":411},{"class":119,"line":410},15,[412],{"type":14,"tag":117,"props":413,"children":414},{"style":136},[415],{"type":20,"value":416},"}\n",{"type":14,"tag":117,"props":418,"children":420},{"class":119,"line":419},16,[421],{"type":14,"tag":117,"props":422,"children":424},{"emptyLinePlaceholder":423},true,[425],{"type":20,"value":426},"\n",{"type":14,"tag":117,"props":428,"children":430},{"class":119,"line":429},17,[431,436],{"type":14,"tag":117,"props":432,"children":433},{"style":124},[434],{"type":20,"value":435},"init_worker_by_lua_block",{"type":14,"tag":117,"props":437,"children":438},{"style":136},[439],{"type":20,"value":218},{"type":14,"tag":117,"props":441,"children":443},{"class":119,"line":442},18,[444,448,452,456,460,465],{"type":14,"tag":117,"props":445,"children":446},{"style":225},[447],{"type":20,"value":228},{"type":14,"tag":117,"props":449,"children":450},{"style":136},[451],{"type":20,"value":233},{"type":14,"tag":117,"props":453,"children":454},{"style":236},[455],{"type":20,"value":239},{"type":14,"tag":117,"props":457,"children":458},{"style":136},[459],{"type":20,"value":244},{"type":14,"tag":117,"props":461,"children":462},{"style":225},[463],{"type":20,"value":464},"init_worker",{"type":14,"tag":117,"props":466,"children":467},{"style":136},[468],{"type":20,"value":469},"()\n",{"type":14,"tag":117,"props":471,"children":473},{"class":119,"line":472},19,[474],{"type":14,"tag":117,"props":475,"children":476},{"style":136},[477],{"type":20,"value":416},{"type":14,"tag":117,"props":479,"children":481},{"class":119,"line":480},20,[482],{"type":14,"tag":117,"props":483,"children":484},{"emptyLinePlaceholder":423},[485],{"type":20,"value":426},{"type":14,"tag":117,"props":487,"children":489},{"class":119,"line":488},21,[490,495],{"type":14,"tag":117,"props":491,"children":492},{"style":124},[493],{"type":20,"value":494},"server",{"type":14,"tag":117,"props":496,"children":497},{"style":136},[498],{"type":20,"value":218},{"type":14,"tag":117,"props":500,"children":502},{"class":119,"line":501},22,[503],{"type":14,"tag":117,"props":504,"children":505},{"style":374},[506],{"type":20,"value":507},"    #listen 80 default_server;\n",{"type":14,"tag":117,"props":509,"children":511},{"class":119,"line":510},23,[512],{"type":14,"tag":117,"props":513,"children":514},{"style":374},[515],{"type":20,"value":516},"    #listen [::]:80 default_server;\n",{"type":14,"tag":117,"props":518,"children":520},{"class":119,"line":519},24,[521,526,531,536],{"type":14,"tag":117,"props":522,"children":523},{"style":124},[524],{"type":20,"value":525},"    listen ",{"type":14,"tag":117,"props":527,"children":528},{"style":130},[529],{"type":20,"value":530},"443",{"type":14,"tag":117,"props":532,"children":533},{"style":136},[534],{"type":20,"value":535}," ssl",{"type":14,"tag":117,"props":537,"children":538},{"style":142},[539],{"type":20,"value":145},{"type":14,"tag":117,"props":541,"children":543},{"class":119,"line":542},25,[544,548,553],{"type":14,"tag":117,"props":545,"children":546},{"style":124},[547],{"type":20,"value":525},{"type":14,"tag":117,"props":549,"children":550},{"style":136},[551],{"type":20,"value":552},"[::]:443 ssl",{"type":14,"tag":117,"props":554,"children":555},{"style":142},[556],{"type":20,"value":145},{"type":14,"tag":117,"props":558,"children":560},{"class":119,"line":559},26,[561,566,571],{"type":14,"tag":117,"props":562,"children":563},{"style":124},[564],{"type":20,"value":565},"    server_name ",{"type":14,"tag":117,"props":567,"children":568},{"style":136},[569],{"type":20,"value":570},"yourmainserver.com",{"type":14,"tag":117,"props":572,"children":573},{"style":142},[574],{"type":20,"value":145},{"type":14,"tag":117,"props":576,"children":578},{"class":119,"line":577},27,[579,584,589],{"type":14,"tag":117,"props":580,"children":581},{"style":124},[582],{"type":20,"value":583},"    ssl_certificate ",{"type":14,"tag":117,"props":585,"children":586},{"style":136},[587],{"type":20,"value":588},"/etc/openresty/default.pem",{"type":14,"tag":117,"props":590,"children":591},{"style":142},[592],{"type":20,"value":145},{"type":14,"tag":117,"props":594,"children":596},{"class":119,"line":595},28,[597,602,607],{"type":14,"tag":117,"props":598,"children":599},{"style":124},[600],{"type":20,"value":601},"    ssl_certificate_key ",{"type":14,"tag":117,"props":603,"children":604},{"style":136},[605],{"type":20,"value":606},"/etc/openresty/default.key",{"type":14,"tag":117,"props":608,"children":609},{"style":142},[610],{"type":20,"value":145},{"type":14,"tag":117,"props":612,"children":614},{"class":119,"line":613},29,[615,620],{"type":14,"tag":117,"props":616,"children":617},{"style":124},[618],{"type":20,"value":619},"    ssl_certificate_by_lua_block",{"type":14,"tag":117,"props":621,"children":622},{"style":136},[623],{"type":20,"value":218},{"type":14,"tag":117,"props":625,"children":627},{"class":119,"line":626},30,[628,633,637,641,645,650],{"type":14,"tag":117,"props":629,"children":630},{"style":225},[631],{"type":20,"value":632},"        require",{"type":14,"tag":117,"props":634,"children":635},{"style":136},[636],{"type":20,"value":233},{"type":14,"tag":117,"props":638,"children":639},{"style":236},[640],{"type":20,"value":239},{"type":14,"tag":117,"props":642,"children":643},{"style":136},[644],{"type":20,"value":244},{"type":14,"tag":117,"props":646,"children":647},{"style":225},[648],{"type":20,"value":649},"ssl_certificate",{"type":14,"tag":117,"props":651,"children":652},{"style":136},[653],{"type":20,"value":469},{"type":14,"tag":117,"props":655,"children":657},{"class":119,"line":656},31,[658],{"type":14,"tag":117,"props":659,"children":660},{"style":136},[661],{"type":20,"value":662},"    } \n",{"type":14,"tag":117,"props":664,"children":666},{"class":119,"line":665},32,[667,672],{"type":14,"tag":117,"props":668,"children":669},{"style":124},[670],{"type":20,"value":671},"    location",{"type":14,"tag":117,"props":673,"children":674},{"style":136},[675],{"type":20,"value":676}," / {\n",{"type":14,"tag":117,"props":678,"children":680},{"class":119,"line":679},33,[681,686],{"type":14,"tag":117,"props":682,"children":683},{"style":124},[684],{"type":20,"value":685},"        access_by_lua_block",{"type":14,"tag":117,"props":687,"children":688},{"style":136},[689],{"type":20,"value":218},{"type":14,"tag":117,"props":691,"children":693},{"class":119,"line":692},34,[694,699,704,708,713,718,722,727,732,737,742],{"type":14,"tag":117,"props":695,"children":696},{"style":124},[697],{"type":20,"value":698},"            local",{"type":14,"tag":117,"props":700,"children":701},{"style":136},[702],{"type":20,"value":703}," res ",{"type":14,"tag":117,"props":705,"children":706},{"style":266},[707],{"type":20,"value":269},{"type":14,"tag":117,"props":709,"children":710},{"style":136},[711],{"type":20,"value":712}," ngx.location.",{"type":14,"tag":117,"props":714,"children":715},{"style":225},[716],{"type":20,"value":717},"capture",{"type":14,"tag":117,"props":719,"children":720},{"style":136},[721],{"type":20,"value":233},{"type":14,"tag":117,"props":723,"children":724},{"style":236},[725],{"type":20,"value":726},"\"/domainCheck/?domain=\" ",{"type":14,"tag":117,"props":728,"children":729},{"style":266},[730],{"type":20,"value":731},"..",{"type":14,"tag":117,"props":733,"children":734},{"style":136},[735],{"type":20,"value":736}," ngx.",{"type":14,"tag":117,"props":738,"children":739},{"style":225},[740],{"type":20,"value":741},"escape_uri",{"type":14,"tag":117,"props":743,"children":744},{"style":136},[745],{"type":20,"value":746},"(ngx.var.host))\n",{"type":14,"tag":117,"props":748,"children":750},{"class":119,"line":749},35,[751,756,761,766,771],{"type":14,"tag":117,"props":752,"children":753},{"style":124},[754],{"type":20,"value":755},"            if",{"type":14,"tag":117,"props":757,"children":758},{"style":136},[759],{"type":20,"value":760}," res.status ",{"type":14,"tag":117,"props":762,"children":763},{"style":266},[764],{"type":20,"value":765},"~=",{"type":14,"tag":117,"props":767,"children":768},{"style":130},[769],{"type":20,"value":770}," 200",{"type":14,"tag":117,"props":772,"children":773},{"style":124},[774],{"type":20,"value":775}," then\n",{"type":14,"tag":117,"props":777,"children":779},{"class":119,"line":778},36,[780,785,790,795,800],{"type":14,"tag":117,"props":781,"children":782},{"style":136},[783],{"type":20,"value":784},"                ngx.",{"type":14,"tag":117,"props":786,"children":787},{"style":225},[788],{"type":20,"value":789},"log",{"type":14,"tag":117,"props":791,"children":792},{"style":136},[793],{"type":20,"value":794},"(ngx.WARN, ",{"type":14,"tag":117,"props":796,"children":797},{"style":236},[798],{"type":20,"value":799},"\"Domain not allowed: \"",{"type":14,"tag":117,"props":801,"children":802},{"style":136},[803],{"type":20,"value":804},", ngx.var.host)\n",{"type":14,"tag":117,"props":806,"children":808},{"class":119,"line":807},37,[809,814,818,823],{"type":14,"tag":117,"props":810,"children":811},{"style":124},[812],{"type":20,"value":813},"                return",{"type":14,"tag":117,"props":815,"children":816},{"style":136},[817],{"type":20,"value":736},{"type":14,"tag":117,"props":819,"children":820},{"style":225},[821],{"type":20,"value":822},"exit",{"type":14,"tag":117,"props":824,"children":825},{"style":136},[826],{"type":20,"value":827},"(ngx.HTTP_FORBIDDEN)\n",{"type":14,"tag":117,"props":829,"children":831},{"class":119,"line":830},38,[832],{"type":14,"tag":117,"props":833,"children":834},{"style":124},[835],{"type":20,"value":836},"            end\n",{"type":14,"tag":117,"props":838,"children":840},{"class":119,"line":839},39,[841],{"type":14,"tag":117,"props":842,"children":843},{"style":136},[844],{"type":20,"value":845},"        }\n",{"type":14,"tag":117,"props":847,"children":849},{"class":119,"line":848},40,[850,855,860],{"type":14,"tag":117,"props":851,"children":852},{"style":124},[853],{"type":20,"value":854},"        proxy_set_header ",{"type":14,"tag":117,"props":856,"children":857},{"style":136},[858],{"type":20,"value":859},"Upgrade $http_upgrade",{"type":14,"tag":117,"props":861,"children":862},{"style":142},[863],{"type":20,"value":145},{"type":14,"tag":117,"props":865,"children":867},{"class":119,"line":866},41,[868,872,877,882],{"type":14,"tag":117,"props":869,"children":870},{"style":124},[871],{"type":20,"value":854},{"type":14,"tag":117,"props":873,"children":874},{"style":136},[875],{"type":20,"value":876},"Connection ",{"type":14,"tag":117,"props":878,"children":879},{"style":236},[880],{"type":20,"value":881},"'Upgrade'",{"type":14,"tag":117,"props":883,"children":884},{"style":142},[885],{"type":20,"value":145},{"type":14,"tag":117,"props":887,"children":889},{"class":119,"line":888},42,[890,895,900],{"type":14,"tag":117,"props":891,"children":892},{"style":124},[893],{"type":20,"value":894},"        proxy_connect_timeout ",{"type":14,"tag":117,"props":896,"children":897},{"style":130},[898],{"type":20,"value":899},"10",{"type":14,"tag":117,"props":901,"children":902},{"style":142},[903],{"type":20,"value":145},{"type":14,"tag":117,"props":905,"children":907},{"class":119,"line":906},43,[908,913,918],{"type":14,"tag":117,"props":909,"children":910},{"style":124},[911],{"type":20,"value":912},"        proxy_send_timeout ",{"type":14,"tag":117,"props":914,"children":915},{"style":130},[916],{"type":20,"value":917},"90",{"type":14,"tag":117,"props":919,"children":920},{"style":142},[921],{"type":20,"value":145},{"type":14,"tag":117,"props":923,"children":925},{"class":119,"line":924},44,[926,931,935],{"type":14,"tag":117,"props":927,"children":928},{"style":124},[929],{"type":20,"value":930},"        proxy_read_timeout ",{"type":14,"tag":117,"props":932,"children":933},{"style":130},[934],{"type":20,"value":917},{"type":14,"tag":117,"props":936,"children":937},{"style":142},[938],{"type":20,"value":145},{"type":14,"tag":117,"props":940,"children":942},{"class":119,"line":941},45,[943,948,953],{"type":14,"tag":117,"props":944,"children":945},{"style":124},[946],{"type":20,"value":947},"        proxy_buffer_size ",{"type":14,"tag":117,"props":949,"children":950},{"style":130},[951],{"type":20,"value":952},"128k",{"type":14,"tag":117,"props":954,"children":955},{"style":142},[956],{"type":20,"value":145},{"type":14,"tag":117,"props":958,"children":960},{"class":119,"line":959},46,[961,966,971,976],{"type":14,"tag":117,"props":962,"children":963},{"style":124},[964],{"type":20,"value":965},"        proxy_buffers ",{"type":14,"tag":117,"props":967,"children":968},{"style":130},[969],{"type":20,"value":970},"4",{"type":14,"tag":117,"props":972,"children":973},{"style":130},[974],{"type":20,"value":975}," 256k",{"type":14,"tag":117,"props":977,"children":978},{"style":142},[979],{"type":20,"value":145},{"type":14,"tag":117,"props":981,"children":983},{"class":119,"line":982},47,[984,989,994],{"type":14,"tag":117,"props":985,"children":986},{"style":124},[987],{"type":20,"value":988},"        proxy_busy_buffers_size ",{"type":14,"tag":117,"props":990,"children":991},{"style":130},[992],{"type":20,"value":993},"256k",{"type":14,"tag":117,"props":995,"children":996},{"style":142},[997],{"type":20,"value":145},{"type":14,"tag":117,"props":999,"children":1001},{"class":119,"line":1000},48,[1002,1007,1011],{"type":14,"tag":117,"props":1003,"children":1004},{"style":124},[1005],{"type":20,"value":1006},"        proxy_temp_file_write_size ",{"type":14,"tag":117,"props":1008,"children":1009},{"style":130},[1010],{"type":20,"value":993},{"type":14,"tag":117,"props":1012,"children":1013},{"style":142},[1014],{"type":20,"value":145},{"type":14,"tag":117,"props":1016,"children":1018},{"class":119,"line":1017},49,[1019,1024,1029,1034],{"type":14,"tag":117,"props":1020,"children":1021},{"style":124},[1022],{"type":20,"value":1023},"        proxy_pass ",{"type":14,"tag":117,"props":1025,"children":1026},{"style":136},[1027],{"type":20,"value":1028},"http://localhost:9292",{"type":14,"tag":117,"props":1030,"children":1031},{"style":142},[1032],{"type":20,"value":1033},";",{"type":14,"tag":117,"props":1035,"children":1036},{"style":374},[1037],{"type":20,"value":1038}," # Your actual website (ex: http://localhost:3000)\n",{"type":14,"tag":117,"props":1040,"children":1042},{"class":119,"line":1041},50,[1043],{"type":14,"tag":117,"props":1044,"children":1045},{"style":136},[1046],{"type":20,"value":1047},"    }\n",{"type":14,"tag":117,"props":1049,"children":1051},{"class":119,"line":1050},51,[1052,1056],{"type":14,"tag":117,"props":1053,"children":1054},{"style":124},[1055],{"type":20,"value":671},{"type":14,"tag":117,"props":1057,"children":1058},{"style":136},[1059],{"type":20,"value":1060}," /.well-known {\n",{"type":14,"tag":117,"props":1062,"children":1064},{"class":119,"line":1063},52,[1065,1069],{"type":14,"tag":117,"props":1066,"children":1067},{"style":124},[1068],{"type":20,"value":685},{"type":14,"tag":117,"props":1070,"children":1071},{"style":136},[1072],{"type":20,"value":218},{"type":14,"tag":117,"props":1074,"children":1076},{"class":119,"line":1075},53,[1077,1081,1085,1089,1093,1097,1101,1105,1109,1113,1117],{"type":14,"tag":117,"props":1078,"children":1079},{"style":124},[1080],{"type":20,"value":698},{"type":14,"tag":117,"props":1082,"children":1083},{"style":136},[1084],{"type":20,"value":703},{"type":14,"tag":117,"props":1086,"children":1087},{"style":266},[1088],{"type":20,"value":269},{"type":14,"tag":117,"props":1090,"children":1091},{"style":136},[1092],{"type":20,"value":712},{"type":14,"tag":117,"props":1094,"children":1095},{"style":225},[1096],{"type":20,"value":717},{"type":14,"tag":117,"props":1098,"children":1099},{"style":136},[1100],{"type":20,"value":233},{"type":14,"tag":117,"props":1102,"children":1103},{"style":236},[1104],{"type":20,"value":726},{"type":14,"tag":117,"props":1106,"children":1107},{"style":266},[1108],{"type":20,"value":731},{"type":14,"tag":117,"props":1110,"children":1111},{"style":136},[1112],{"type":20,"value":736},{"type":14,"tag":117,"props":1114,"children":1115},{"style":225},[1116],{"type":20,"value":741},{"type":14,"tag":117,"props":1118,"children":1119},{"style":136},[1120],{"type":20,"value":746},{"type":14,"tag":117,"props":1122,"children":1124},{"class":119,"line":1123},54,[1125,1129,1133,1137,1141],{"type":14,"tag":117,"props":1126,"children":1127},{"style":124},[1128],{"type":20,"value":755},{"type":14,"tag":117,"props":1130,"children":1131},{"style":136},[1132],{"type":20,"value":760},{"type":14,"tag":117,"props":1134,"children":1135},{"style":266},[1136],{"type":20,"value":765},{"type":14,"tag":117,"props":1138,"children":1139},{"style":130},[1140],{"type":20,"value":770},{"type":14,"tag":117,"props":1142,"children":1143},{"style":124},[1144],{"type":20,"value":775},{"type":14,"tag":117,"props":1146,"children":1148},{"class":119,"line":1147},55,[1149,1153,1157,1161,1165],{"type":14,"tag":117,"props":1150,"children":1151},{"style":136},[1152],{"type":20,"value":784},{"type":14,"tag":117,"props":1154,"children":1155},{"style":225},[1156],{"type":20,"value":789},{"type":14,"tag":117,"props":1158,"children":1159},{"style":136},[1160],{"type":20,"value":794},{"type":14,"tag":117,"props":1162,"children":1163},{"style":236},[1164],{"type":20,"value":799},{"type":14,"tag":117,"props":1166,"children":1167},{"style":136},[1168],{"type":20,"value":804},{"type":14,"tag":117,"props":1170,"children":1172},{"class":119,"line":1171},56,[1173,1177,1181,1185],{"type":14,"tag":117,"props":1174,"children":1175},{"style":124},[1176],{"type":20,"value":813},{"type":14,"tag":117,"props":1178,"children":1179},{"style":136},[1180],{"type":20,"value":736},{"type":14,"tag":117,"props":1182,"children":1183},{"style":225},[1184],{"type":20,"value":822},{"type":14,"tag":117,"props":1186,"children":1187},{"style":136},[1188],{"type":20,"value":827},{"type":14,"tag":117,"props":1190,"children":1192},{"class":119,"line":1191},57,[1193],{"type":14,"tag":117,"props":1194,"children":1195},{"style":124},[1196],{"type":20,"value":836},{"type":14,"tag":117,"props":1198,"children":1200},{"class":119,"line":1199},58,[1201],{"type":14,"tag":117,"props":1202,"children":1203},{"style":136},[1204],{"type":20,"value":845},{"type":14,"tag":117,"props":1206,"children":1208},{"class":119,"line":1207},59,[1209,1214],{"type":14,"tag":117,"props":1210,"children":1211},{"style":124},[1212],{"type":20,"value":1213},"        content_by_lua_block",{"type":14,"tag":117,"props":1215,"children":1216},{"style":136},[1217],{"type":20,"value":218},{"type":14,"tag":117,"props":1219,"children":1221},{"class":119,"line":1220},60,[1222,1227,1231,1235,1239,1244],{"type":14,"tag":117,"props":1223,"children":1224},{"style":225},[1225],{"type":20,"value":1226},"            require",{"type":14,"tag":117,"props":1228,"children":1229},{"style":136},[1230],{"type":20,"value":233},{"type":14,"tag":117,"props":1232,"children":1233},{"style":236},[1234],{"type":20,"value":239},{"type":14,"tag":117,"props":1236,"children":1237},{"style":136},[1238],{"type":20,"value":244},{"type":14,"tag":117,"props":1240,"children":1241},{"style":225},[1242],{"type":20,"value":1243},"serve_http_challenge",{"type":14,"tag":117,"props":1245,"children":1246},{"style":136},[1247],{"type":20,"value":469},{"type":14,"tag":117,"props":1249,"children":1251},{"class":119,"line":1250},61,[1252],{"type":14,"tag":117,"props":1253,"children":1254},{"style":136},[1255],{"type":20,"value":845},{"type":14,"tag":117,"props":1257,"children":1259},{"class":119,"line":1258},62,[1260],{"type":14,"tag":117,"props":1261,"children":1262},{"style":136},[1263],{"type":20,"value":1047},{"type":14,"tag":117,"props":1265,"children":1267},{"class":119,"line":1266},63,[1268,1272],{"type":14,"tag":117,"props":1269,"children":1270},{"style":124},[1271],{"type":20,"value":671},{"type":14,"tag":117,"props":1273,"children":1274},{"style":136},[1275],{"type":20,"value":1276}," /domainCheck {\n",{"type":14,"tag":117,"props":1278,"children":1280},{"class":119,"line":1279},64,[1281,1286],{"type":14,"tag":117,"props":1282,"children":1283},{"style":124},[1284],{"type":20,"value":1285},"        internal",{"type":14,"tag":117,"props":1287,"children":1288},{"style":142},[1289],{"type":20,"value":145},{"type":14,"tag":117,"props":1291,"children":1293},{"class":119,"line":1292},65,[1294,1298,1303,1307],{"type":14,"tag":117,"props":1295,"children":1296},{"style":124},[1297],{"type":20,"value":1023},{"type":14,"tag":117,"props":1299,"children":1300},{"style":136},[1301],{"type":20,"value":1302},"http://localhost:9292/domainCheck",{"type":14,"tag":117,"props":1304,"children":1305},{"style":142},[1306],{"type":20,"value":1033},{"type":14,"tag":117,"props":1308,"children":1309},{"style":374},[1310],{"type":20,"value":1311},"  # Adjust the URL if needed\n",{"type":14,"tag":117,"props":1313,"children":1315},{"class":119,"line":1314},66,[1316,1320,1325],{"type":14,"tag":117,"props":1317,"children":1318},{"style":124},[1319],{"type":20,"value":854},{"type":14,"tag":117,"props":1321,"children":1322},{"style":136},[1323],{"type":20,"value":1324},"Host $host",{"type":14,"tag":117,"props":1326,"children":1327},{"style":142},[1328],{"type":20,"value":145},{"type":14,"tag":117,"props":1330,"children":1332},{"class":119,"line":1331},67,[1333,1337,1342],{"type":14,"tag":117,"props":1334,"children":1335},{"style":124},[1336],{"type":20,"value":854},{"type":14,"tag":117,"props":1338,"children":1339},{"style":136},[1340],{"type":20,"value":1341},"X-Real-IP $remote_addr",{"type":14,"tag":117,"props":1343,"children":1344},{"style":142},[1345],{"type":20,"value":145},{"type":14,"tag":117,"props":1347,"children":1349},{"class":119,"line":1348},68,[1350,1354,1359],{"type":14,"tag":117,"props":1351,"children":1352},{"style":124},[1353],{"type":20,"value":854},{"type":14,"tag":117,"props":1355,"children":1356},{"style":136},[1357],{"type":20,"value":1358},"X-Forwarded-For $proxy_add_x_forwarded_for",{"type":14,"tag":117,"props":1360,"children":1361},{"style":142},[1362],{"type":20,"value":145},{"type":14,"tag":117,"props":1364,"children":1366},{"class":119,"line":1365},69,[1367,1371,1376],{"type":14,"tag":117,"props":1368,"children":1369},{"style":124},[1370],{"type":20,"value":854},{"type":14,"tag":117,"props":1372,"children":1373},{"style":136},[1374],{"type":20,"value":1375},"X-Forwarded-Proto $scheme",{"type":14,"tag":117,"props":1377,"children":1378},{"style":142},[1379],{"type":20,"value":145},{"type":14,"tag":117,"props":1381,"children":1383},{"class":119,"line":1382},70,[1384],{"type":14,"tag":117,"props":1385,"children":1386},{"style":136},[1387],{"type":20,"value":1047},{"type":14,"tag":117,"props":1389,"children":1391},{"class":119,"line":1390},71,[1392],{"type":14,"tag":117,"props":1393,"children":1394},{"style":136},[1395],{"type":20,"value":416},{"type":14,"tag":26,"props":1397,"children":1399},{"id":1398},"explanation",[1400],{"type":20,"value":1401},"Explanation",{"type":14,"tag":33,"props":1403,"children":1404},{},[1405],{"type":20,"value":1406},"This configuration is a bit complex, but I'll try to explain it as best as I can.",{"type":14,"tag":45,"props":1408,"children":1409},{},[1410,1445,1498,1509],{"type":14,"tag":49,"props":1411,"children":1412},{},[1413,1415,1422],{"type":20,"value":1414},"The following directives were copied and pasted from the ",{"type":14,"tag":95,"props":1416,"children":1419},{"href":1417,"rel":1418},"https://github.com/fffonion/lua-resty-acme",[99],[1420],{"type":20,"value":1421},"lua-resty-acme repo",{"type":14,"tag":45,"props":1423,"children":1424},{},[1425,1430,1435,1440],{"type":14,"tag":49,"props":1426,"children":1427},{},[1428],{"type":20,"value":1429},"resolver: This is the DNS resolver used to resolve the domain.",{"type":14,"tag":49,"props":1431,"children":1432},{},[1433],{"type":20,"value":1434},"lua_shared_dict: This is used to store the certificates.",{"type":14,"tag":49,"props":1436,"children":1437},{},[1438],{"type":20,"value":1439},"lua_ssl_trusted_certificate: This is used to verify the Let's Encrypt API.",{"type":14,"tag":49,"props":1441,"children":1442},{},[1443],{"type":20,"value":1444},"lua_ssl_verify_depth: This is used to verify the Let's Encrypt API.",{"type":14,"tag":49,"props":1446,"children":1447},{},[1448,1450,1455,1457],{"type":20,"value":1449},"The ",{"type":14,"tag":113,"props":1451,"children":1453},{"className":1452},[],[1454],{"type":20,"value":213},{"type":20,"value":1456}," is used to initialize the Let's Encrypt API. This is where you can set the email, domain whitelist, and other settings.",{"type":14,"tag":45,"props":1458,"children":1459},{},[1460,1465,1470,1475,1488,1493],{"type":14,"tag":49,"props":1461,"children":1462},{},[1463],{"type":20,"value":1464},"tos_accepted: This is used to accept the Let's Encrypt TOS.",{"type":14,"tag":49,"props":1466,"children":1467},{},[1468],{"type":20,"value":1469},"account_key_path: This is the path to your account key.",{"type":14,"tag":49,"props":1471,"children":1472},{},[1473],{"type":20,"value":1474},"account_email: This is the email used to register the account.",{"type":14,"tag":49,"props":1476,"children":1477},{},[1478,1480,1486],{"type":20,"value":1479},"domain_whitelist: This is the list of domains that are allowed (set to nil as we will check this in the ",{"type":14,"tag":113,"props":1481,"children":1483},{"className":1482},[],[1484],{"type":20,"value":1485},"location /",{"type":20,"value":1487}," block).",{"type":14,"tag":49,"props":1489,"children":1490},{},[1491],{"type":20,"value":1492},"blocking: This is used to block the request until the certificate is generated. This could be set to false, but I felt like it was better to immediatley use the generated SSL certificate instead of using the fallbacks.",{"type":14,"tag":49,"props":1494,"children":1495},{},[1496],{"type":20,"value":1497},"staging: This is used to use the Let's Encrypt staging API. This is useful for testing and should be removed in production.",{"type":14,"tag":49,"props":1499,"children":1500},{},[1501,1502,1507],{"type":20,"value":1449},{"type":14,"tag":113,"props":1503,"children":1505},{"className":1504},[],[1506],{"type":20,"value":435},{"type":20,"value":1508}," is used to initialize the worker. This is where the certificate is generated.",{"type":14,"tag":49,"props":1510,"children":1511},{},[1512,1513,1518,1520],{"type":20,"value":1449},{"type":14,"tag":113,"props":1514,"children":1516},{"className":1515},[],[1517],{"type":20,"value":494},{"type":20,"value":1519}," block is where the actual server configuration is. This is where the domain is checked and the ACME http challenge is served.",{"type":14,"tag":45,"props":1521,"children":1522},{},[1523,1535,1547,1566,1578,1626,1677],{"type":14,"tag":49,"props":1524,"children":1525},{},[1526,1527,1533],{"type":20,"value":1449},{"type":14,"tag":113,"props":1528,"children":1530},{"className":1529},[],[1531],{"type":20,"value":1532},"listen",{"type":20,"value":1534}," directives are used to listen on port 443 and 80.",{"type":14,"tag":49,"props":1536,"children":1537},{},[1538,1539,1545],{"type":20,"value":1449},{"type":14,"tag":113,"props":1540,"children":1542},{"className":1541},[],[1543],{"type":20,"value":1544},"server_name",{"type":20,"value":1546}," directive is used to specify the main server name.",{"type":14,"tag":49,"props":1548,"children":1549},{},[1550,1551,1556,1558,1564],{"type":20,"value":1449},{"type":14,"tag":113,"props":1552,"children":1554},{"className":1553},[],[1555],{"type":20,"value":649},{"type":20,"value":1557}," and ",{"type":14,"tag":113,"props":1559,"children":1561},{"className":1560},[],[1562],{"type":20,"value":1563},"ssl_certificate_key",{"type":20,"value":1565}," directives are used to specify the default certificate and key. This is used to serve the default certificate until the certificate is generated.",{"type":14,"tag":49,"props":1567,"children":1568},{},[1569,1570,1576],{"type":20,"value":1449},{"type":14,"tag":113,"props":1571,"children":1573},{"className":1572},[],[1574],{"type":20,"value":1575},"ssl_certificate_by_lua_block",{"type":20,"value":1577}," is used to generate the SSL certificate.",{"type":14,"tag":49,"props":1579,"children":1580},{},[1581,1582,1587,1589],{"type":20,"value":1449},{"type":14,"tag":113,"props":1583,"children":1585},{"className":1584},[],[1586],{"type":20,"value":1485},{"type":20,"value":1588}," block is used to check if the domain is allowed. If it is not, it will return a 403.\n",{"type":14,"tag":45,"props":1590,"children":1591},{},[1592],{"type":14,"tag":49,"props":1593,"children":1594},{},[1595,1596,1602,1604],{"type":20,"value":1449},{"type":14,"tag":113,"props":1597,"children":1599},{"className":1598},[],[1600],{"type":20,"value":1601},"access_by_lua_block",{"type":20,"value":1603}," is used to check if the domain is allowed.\n",{"type":14,"tag":1605,"props":1606,"children":1607},"ol",{},[1608,1621],{"type":14,"tag":49,"props":1609,"children":1610},{},[1611,1613,1619],{"type":20,"value":1612},"We first capture the response from the ",{"type":14,"tag":113,"props":1614,"children":1616},{"className":1615},[],[1617],{"type":20,"value":1618},"/domainCheck",{"type":20,"value":1620}," location.",{"type":14,"tag":49,"props":1622,"children":1623},{},[1624],{"type":20,"value":1625},"If the status is not 200, we log a warning and return a 403.",{"type":14,"tag":49,"props":1627,"children":1628},{},[1629,1630,1636,1638],{"type":20,"value":1449},{"type":14,"tag":113,"props":1631,"children":1633},{"className":1632},[],[1634],{"type":20,"value":1635},"location /domainCheck",{"type":20,"value":1637}," block is used to check if the domain is allowed.\n",{"type":14,"tag":45,"props":1639,"children":1640},{},[1641,1653,1665],{"type":14,"tag":49,"props":1642,"children":1643},{},[1644,1645,1651],{"type":20,"value":1449},{"type":14,"tag":113,"props":1646,"children":1648},{"className":1647},[],[1649],{"type":20,"value":1650},"internal",{"type":20,"value":1652}," directive is used to prevent direct access to the location.",{"type":14,"tag":49,"props":1654,"children":1655},{},[1656,1657,1663],{"type":20,"value":1449},{"type":14,"tag":113,"props":1658,"children":1660},{"className":1659},[],[1661],{"type":20,"value":1662},"proxy_pass",{"type":20,"value":1664}," directive is used to pass the request to our actual http server that verifies the domain against a database or list. If it is allowed, it sends a 200 status code.",{"type":14,"tag":49,"props":1666,"children":1667},{},[1668,1669,1675],{"type":20,"value":1449},{"type":14,"tag":113,"props":1670,"children":1672},{"className":1671},[],[1673],{"type":20,"value":1674},"proxy_set_header",{"type":20,"value":1676}," directives are used to set the headers.",{"type":14,"tag":49,"props":1678,"children":1679},{},[1680,1681,1687,1689],{"type":20,"value":1449},{"type":14,"tag":113,"props":1682,"children":1684},{"className":1683},[],[1685],{"type":20,"value":1686},"location /.well-known",{"type":20,"value":1688}," block is used to serve the ACME http challenge.\n",{"type":14,"tag":45,"props":1690,"children":1691},{},[1692,1697],{"type":14,"tag":49,"props":1693,"children":1694},{},[1695],{"type":20,"value":1696},"We also check if the domain is allowed here as to not spam the Let's Encrypt API.",{"type":14,"tag":49,"props":1698,"children":1699},{},[1700,1701,1707],{"type":20,"value":1449},{"type":14,"tag":113,"props":1702,"children":1704},{"className":1703},[],[1705],{"type":20,"value":1706},"content_by_lua_block",{"type":20,"value":1708}," is used to serve the ACME http challenge.",{"type":14,"tag":26,"props":1710,"children":1712},{"id":1711},"how-i-figured-it-out",[1713],{"type":20,"value":1714},"How I figured it out",{"type":14,"tag":33,"props":1716,"children":1717},{},[1718,1720,1727,1729,1736,1738,1743],{"type":20,"value":1719},"I first started with the config provided by the ",{"type":14,"tag":95,"props":1721,"children":1724},{"href":1722,"rel":1723},"https://docs.titaniumnetwork.org/guides/nginx",[99],[1725],{"type":20,"value":1726},"TitaniumNetwork Docs",{"type":20,"value":1728},"\nThen I started looking at how to get the domain from the request and how to check if it was allowed.\nI was using normal NGINX, but I quickly realized that I needed to use Lua to get the domain and check if it was allowed.\nI then found the ",{"type":14,"tag":95,"props":1730,"children":1733},{"href":1731,"rel":1732},"https://github.com/auto-ssl/lua-resty-auto-ssl/",[99],[1734],{"type":20,"value":1735},"lua-resty-auto-ssl repo",{"type":20,"value":1737}," but quickly realized it was unmaintained and kept searching.\nThen I found the ",{"type":14,"tag":95,"props":1739,"children":1741},{"href":1417,"rel":1740},[99],[1742],{"type":20,"value":1421},{"type":20,"value":1744}," and started using that.\nThe rest was trial and error with a shit ton of Googling.",{"type":14,"tag":26,"props":1746,"children":1748},{"id":1747},"final-thoughts",[1749],{"type":20,"value":1750},"Final thoughts",{"type":14,"tag":33,"props":1752,"children":1753},{},[1754,1756],{"type":20,"value":1755},"This was a rather fun challenge, allowing me to learn crap tons of stuff about how NGINX and OpenResty works and had fun while doing so.\nThe repo providing a Discord bot, http server, database and this config is located ",{"type":14,"tag":95,"props":1757,"children":1760},{"href":1758,"rel":1759},"https://github.com/ruby-network/byod-bot",[99],[1761],{"type":20,"value":1762},"here",{"type":14,"tag":26,"props":1764,"children":1766},{"id":1765},"credits",[1767],{"type":20,"value":1768},"Credits:",{"type":14,"tag":45,"props":1770,"children":1771},{},[1772,1783,1795],{"type":14,"tag":49,"props":1773,"children":1774},{},[1775,1781],{"type":14,"tag":95,"props":1776,"children":1779},{"href":1777,"rel":1778},"https://docs.titaniumnetwork.org",[99],[1780],{"type":20,"value":1726},{"type":20,"value":1782}," for the base config.",{"type":14,"tag":49,"props":1784,"children":1785},{},[1786,1787,1793],{"type":20,"value":1449},{"type":14,"tag":95,"props":1788,"children":1790},{"href":1417,"rel":1789},[99],[1791],{"type":20,"value":1792},"lua resty acme repo",{"type":20,"value":1794}," for the auto ssl stuff.",{"type":14,"tag":49,"props":1796,"children":1797},{},[1798,1799,1806],{"type":20,"value":1449},{"type":14,"tag":95,"props":1800,"children":1803},{"href":1801,"rel":1802},"https://caddyserver.com/docs/automatic-https#on-demand-tls",[99],[1804],{"type":20,"value":1805},"On Demand TLS feature by Caddy",{"type":20,"value":1807}," which this was inspired by.",{"type":14,"tag":1809,"props":1810,"children":1811},"style",{},[1812],{"type":20,"value":1813},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}",{"title":7,"searchDepth":148,"depth":148,"links":1815},[1816,1817,1818,1819,1820,1821,1822,1823],{"id":28,"depth":148,"text":31},{"id":40,"depth":148,"text":43},{"id":74,"depth":148,"text":77},{"id":85,"depth":148,"text":88},{"id":1398,"depth":148,"text":1401},{"id":1711,"depth":148,"text":1714},{"id":1747,"depth":148,"text":1750},{"id":1765,"depth":148,"text":1768},"markdown","content:blog:nginx-byod.md","content","blog/nginx-byod.md","md",1714628683076]