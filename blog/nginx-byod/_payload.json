[{"data":1,"prerenderedAt":1818},["Reactive",2],{"content-query-uxqjqCxGNs":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":9,"body":10,"_type":1813,"_id":1814,"_source":1815,"_file":1816,"_extension":1817},"/blog/nginx-byod","blog",false,"","Making an NGINX config for BYOD (Bring Your Own Domain)","Why and how I made an NGINX config for BYOD",{"type":11,"children":12,"toc":1803},"root",[13,21,25,32,38,44,72,78,83,89,105,1385,1391,1396,1698,1704,1734,1740,1752,1758,1797],{"type":14,"tag":15,"props":16,"children":18},"element","h1",{"id":17},"making-an-nginx-config-for-byod-bring-your-own-domain",[19],{"type":20,"value":8},"text",{"type":14,"tag":22,"props":23,"children":24},"hr",{},[],{"type":14,"tag":26,"props":27,"children":29},"h2",{"id":28},"what-is-byod",[30],{"type":20,"value":31},"What is BYOD?",{"type":14,"tag":33,"props":34,"children":35},"p",{},[36],{"type":20,"value":37},"BYOD or Bring your own domain is an idea or concept that allows a user to point their domain to a servers IP allowing them to use the website from said domain.",{"type":14,"tag":26,"props":39,"children":41},{"id":40},"the-challenges",[42],{"type":20,"value":43},"The challenges",{"type":14,"tag":45,"props":46,"children":47},"ul",{},[48,54,67],{"type":14,"tag":49,"props":50,"children":51},"li",{},[52],{"type":20,"value":53},"The server needs to throw a 403 if the domain is not in the list or database.",{"type":14,"tag":49,"props":55,"children":56},{},[57,59,65],{"type":20,"value":58},"The server ",{"type":14,"tag":60,"props":61,"children":62},"em",{},[63],{"type":20,"value":64},"must",{"type":20,"value":66}," generate a valid SSL certificate on the fly for the domain. Why? Because we don't want to have to manually generate certificates for every domain added.",{"type":14,"tag":49,"props":68,"children":69},{},[70],{"type":20,"value":71},"It must be semi-easy to implement into already existing configurations.",{"type":14,"tag":26,"props":73,"children":75},{"id":74},"but-why",[76],{"type":20,"value":77},"But why?",{"type":14,"tag":33,"props":79,"children":80},{},[81],{"type":20,"value":82},"I was asked if I had an idea of how to do it, and so I thought what the hell, let's give it a shot.\nI don't mess with Nginx configurations that much, so I thought it would be a good learning experience.",{"type":14,"tag":26,"props":84,"children":86},{"id":85},"the-solution",[87],{"type":20,"value":88},"The solution",{"type":14,"tag":33,"props":90,"children":91},{},[92,94,103],{"type":20,"value":93},"First, I should specify that this uses ",{"type":14,"tag":95,"props":96,"children":100},"a",{"href":97,"rel":98},"https://openresty.org/en/",[99],"nofollow",[101],{"type":20,"value":102},"OpenResty",{"type":20,"value":104}," which is a bundle of Nginx and LuaJIT. This is allows us to use Lua in our Nginx configuration.",{"type":14,"tag":106,"props":107,"children":111},"pre",{"className":108,"code":109,"language":110,"meta":7,"style":7},"language-nginx shiki shiki-themes catppuccin-frappe","resolver 8.8.8.8 ipv6=off;\nlua_shared_dict acme 16m;\nlua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;\nlua_ssl_verify_depth 2;\ninit_by_lua_block {\n    require(\"resty.acme.autossl\").init({\n        tos_accepted = true,\n        account_key_path = \"/etc/openresty/account.key\",\n        account_email = \"youremail@yourdomain.com\",\n        domain_whitelist = nil,\n        blocking = true,\n        -- remove in production\n        staging = true,\n    })\n}\n\ninit_worker_by_lua_block {\n    require(\"resty.acme.autossl\").init_worker()\n}\n\nserver {\n    #listen 80 default_server;\n    #listen [::]:80 default_server;\n    listen 443 ssl;\n    listen [::]:443 ssl;\n    server_name yourmainserver.com;\n    ssl_certificate /etc/openresty/default.pem;\n    ssl_certificate_key /etc/openresty/default.key;\n    ssl_certificate_by_lua_block {\n        require(\"resty.acme.autossl\").ssl_certificate()\n    } \n    location / {\n        access_by_lua_block {\n            local res = ngx.location.capture(\"/domainCheck/?domain=\" .. ngx.escape_uri(ngx.var.host))\n            if res.status ~= 200 then\n                ngx.log(ngx.WARN, \"Domain not allowed: \", ngx.var.host)\n                return ngx.exit(ngx.HTTP_FORBIDDEN)\n            end\n        }\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'Upgrade';\n        proxy_connect_timeout 10;\n        proxy_send_timeout 90;\n        proxy_read_timeout 90;\n        proxy_buffer_size 128k;\n        proxy_buffers 4 256k;\n        proxy_busy_buffers_size 256k;\n        proxy_temp_file_write_size 256k;\n        proxy_pass http://localhost:9292; # Your actual website (ex: http://localhost:3000)\n    }\n    location /.well-known {\n        access_by_lua_block {\n            local res = ngx.location.capture(\"/domainCheck/?domain=\" .. ngx.escape_uri(ngx.var.host))\n            if res.status ~= 200 then\n                ngx.log(ngx.WARN, \"Domain not allowed: \", ngx.var.host)\n                return ngx.exit(ngx.HTTP_FORBIDDEN)\n            end\n        }\n        content_by_lua_block {\n            require(\"resty.acme.autossl\").serve_http_challenge()\n        }\n    }\n    location /domainCheck {\n        internal;\n        proxy_pass http://localhost:9292/domainCheck;  # Adjust the URL if needed\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n    }\n}\n","nginx",[112],{"type":14,"tag":113,"props":114,"children":115},"code",{"__ignoreMap":7},[116,140,164,182,200,214,250,276,298,320,342,363,373,394,403,412,422,435,465,473,481,494,503,512,530,547,565,583,601,614,644,653,667,680,737,766,795,818,827,836,854,876,894,912,929,947,970,987,1004,1028,1037,1050,1062,1110,1134,1158,1178,1186,1194,1207,1237,1245,1253,1266,1279,1301,1318,1335,1352,1369,1377],{"type":14,"tag":117,"props":118,"children":121},"span",{"class":119,"line":120},"line",1,[122,128,134],{"type":14,"tag":117,"props":123,"children":125},{"style":124},"--shiki-default:#CA9EE6",[126],{"type":20,"value":127},"resolver ",{"type":14,"tag":117,"props":129,"children":131},{"style":130},"--shiki-default:#C6D0F5",[132],{"type":20,"value":133},"8.8.8.8 ipv6=off",{"type":14,"tag":117,"props":135,"children":137},{"style":136},"--shiki-default:#949CBB",[138],{"type":20,"value":139},";\n",{"type":14,"tag":117,"props":141,"children":143},{"class":119,"line":142},2,[144,149,154,160],{"type":14,"tag":117,"props":145,"children":146},{"style":124},[147],{"type":20,"value":148},"lua_shared_dict",{"type":14,"tag":117,"props":150,"children":151},{"style":130},[152],{"type":20,"value":153}," acme ",{"type":14,"tag":117,"props":155,"children":157},{"style":156},"--shiki-default:#EF9F76",[158],{"type":20,"value":159},"16m",{"type":14,"tag":117,"props":161,"children":162},{"style":136},[163],{"type":20,"value":139},{"type":14,"tag":117,"props":165,"children":167},{"class":119,"line":166},3,[168,173,178],{"type":14,"tag":117,"props":169,"children":170},{"style":124},[171],{"type":20,"value":172},"lua_ssl_trusted_certificate",{"type":14,"tag":117,"props":174,"children":175},{"style":130},[176],{"type":20,"value":177}," /etc/ssl/certs/ca-certificates.crt",{"type":14,"tag":117,"props":179,"children":180},{"style":136},[181],{"type":20,"value":139},{"type":14,"tag":117,"props":183,"children":185},{"class":119,"line":184},4,[186,191,196],{"type":14,"tag":117,"props":187,"children":188},{"style":124},[189],{"type":20,"value":190},"lua_ssl_verify_depth",{"type":14,"tag":117,"props":192,"children":193},{"style":130},[194],{"type":20,"value":195}," 2",{"type":14,"tag":117,"props":197,"children":198},{"style":136},[199],{"type":20,"value":139},{"type":14,"tag":117,"props":201,"children":203},{"class":119,"line":202},5,[204,209],{"type":14,"tag":117,"props":205,"children":206},{"style":124},[207],{"type":20,"value":208},"init_by_lua_block",{"type":14,"tag":117,"props":210,"children":211},{"style":130},[212],{"type":20,"value":213}," {\n",{"type":14,"tag":117,"props":215,"children":217},{"class":119,"line":216},6,[218,224,229,235,240,245],{"type":14,"tag":117,"props":219,"children":221},{"style":220},"--shiki-default:#8CAAEE;--shiki-default-font-style:italic",[222],{"type":20,"value":223},"    require",{"type":14,"tag":117,"props":225,"children":226},{"style":130},[227],{"type":20,"value":228},"(",{"type":14,"tag":117,"props":230,"children":232},{"style":231},"--shiki-default:#A6D189",[233],{"type":20,"value":234},"\"resty.acme.autossl\"",{"type":14,"tag":117,"props":236,"children":237},{"style":130},[238],{"type":20,"value":239},").",{"type":14,"tag":117,"props":241,"children":242},{"style":220},[243],{"type":20,"value":244},"init",{"type":14,"tag":117,"props":246,"children":247},{"style":130},[248],{"type":20,"value":249},"({\n",{"type":14,"tag":117,"props":251,"children":253},{"class":119,"line":252},7,[254,259,265,271],{"type":14,"tag":117,"props":255,"children":256},{"style":130},[257],{"type":20,"value":258},"        tos_accepted ",{"type":14,"tag":117,"props":260,"children":262},{"style":261},"--shiki-default:#81C8BE",[263],{"type":20,"value":264},"=",{"type":14,"tag":117,"props":266,"children":268},{"style":267},"--shiki-default:#E78284",[269],{"type":20,"value":270}," true",{"type":14,"tag":117,"props":272,"children":273},{"style":130},[274],{"type":20,"value":275},",\n",{"type":14,"tag":117,"props":277,"children":279},{"class":119,"line":278},8,[280,285,289,294],{"type":14,"tag":117,"props":281,"children":282},{"style":130},[283],{"type":20,"value":284},"        account_key_path ",{"type":14,"tag":117,"props":286,"children":287},{"style":261},[288],{"type":20,"value":264},{"type":14,"tag":117,"props":290,"children":291},{"style":231},[292],{"type":20,"value":293}," \"/etc/openresty/account.key\"",{"type":14,"tag":117,"props":295,"children":296},{"style":130},[297],{"type":20,"value":275},{"type":14,"tag":117,"props":299,"children":301},{"class":119,"line":300},9,[302,307,311,316],{"type":14,"tag":117,"props":303,"children":304},{"style":130},[305],{"type":20,"value":306},"        account_email ",{"type":14,"tag":117,"props":308,"children":309},{"style":261},[310],{"type":20,"value":264},{"type":14,"tag":117,"props":312,"children":313},{"style":231},[314],{"type":20,"value":315}," \"youremail@yourdomain.com\"",{"type":14,"tag":117,"props":317,"children":318},{"style":130},[319],{"type":20,"value":275},{"type":14,"tag":117,"props":321,"children":323},{"class":119,"line":322},10,[324,329,333,338],{"type":14,"tag":117,"props":325,"children":326},{"style":130},[327],{"type":20,"value":328},"        domain_whitelist ",{"type":14,"tag":117,"props":330,"children":331},{"style":261},[332],{"type":20,"value":264},{"type":14,"tag":117,"props":334,"children":335},{"style":267},[336],{"type":20,"value":337}," nil",{"type":14,"tag":117,"props":339,"children":340},{"style":130},[341],{"type":20,"value":275},{"type":14,"tag":117,"props":343,"children":345},{"class":119,"line":344},11,[346,351,355,359],{"type":14,"tag":117,"props":347,"children":348},{"style":130},[349],{"type":20,"value":350},"        blocking ",{"type":14,"tag":117,"props":352,"children":353},{"style":261},[354],{"type":20,"value":264},{"type":14,"tag":117,"props":356,"children":357},{"style":267},[358],{"type":20,"value":270},{"type":14,"tag":117,"props":360,"children":361},{"style":130},[362],{"type":20,"value":275},{"type":14,"tag":117,"props":364,"children":366},{"class":119,"line":365},12,[367],{"type":14,"tag":117,"props":368,"children":370},{"style":369},"--shiki-default:#737994;--shiki-default-font-style:italic",[371],{"type":20,"value":372},"        -- remove in production\n",{"type":14,"tag":117,"props":374,"children":376},{"class":119,"line":375},13,[377,382,386,390],{"type":14,"tag":117,"props":378,"children":379},{"style":130},[380],{"type":20,"value":381},"        staging ",{"type":14,"tag":117,"props":383,"children":384},{"style":261},[385],{"type":20,"value":264},{"type":14,"tag":117,"props":387,"children":388},{"style":267},[389],{"type":20,"value":270},{"type":14,"tag":117,"props":391,"children":392},{"style":130},[393],{"type":20,"value":275},{"type":14,"tag":117,"props":395,"children":397},{"class":119,"line":396},14,[398],{"type":14,"tag":117,"props":399,"children":400},{"style":130},[401],{"type":20,"value":402},"    })\n",{"type":14,"tag":117,"props":404,"children":406},{"class":119,"line":405},15,[407],{"type":14,"tag":117,"props":408,"children":409},{"style":130},[410],{"type":20,"value":411},"}\n",{"type":14,"tag":117,"props":413,"children":415},{"class":119,"line":414},16,[416],{"type":14,"tag":117,"props":417,"children":419},{"emptyLinePlaceholder":418},true,[420],{"type":20,"value":421},"\n",{"type":14,"tag":117,"props":423,"children":425},{"class":119,"line":424},17,[426,431],{"type":14,"tag":117,"props":427,"children":428},{"style":124},[429],{"type":20,"value":430},"init_worker_by_lua_block",{"type":14,"tag":117,"props":432,"children":433},{"style":130},[434],{"type":20,"value":213},{"type":14,"tag":117,"props":436,"children":438},{"class":119,"line":437},18,[439,443,447,451,455,460],{"type":14,"tag":117,"props":440,"children":441},{"style":220},[442],{"type":20,"value":223},{"type":14,"tag":117,"props":444,"children":445},{"style":130},[446],{"type":20,"value":228},{"type":14,"tag":117,"props":448,"children":449},{"style":231},[450],{"type":20,"value":234},{"type":14,"tag":117,"props":452,"children":453},{"style":130},[454],{"type":20,"value":239},{"type":14,"tag":117,"props":456,"children":457},{"style":220},[458],{"type":20,"value":459},"init_worker",{"type":14,"tag":117,"props":461,"children":462},{"style":130},[463],{"type":20,"value":464},"()\n",{"type":14,"tag":117,"props":466,"children":468},{"class":119,"line":467},19,[469],{"type":14,"tag":117,"props":470,"children":471},{"style":130},[472],{"type":20,"value":411},{"type":14,"tag":117,"props":474,"children":476},{"class":119,"line":475},20,[477],{"type":14,"tag":117,"props":478,"children":479},{"emptyLinePlaceholder":418},[480],{"type":20,"value":421},{"type":14,"tag":117,"props":482,"children":484},{"class":119,"line":483},21,[485,490],{"type":14,"tag":117,"props":486,"children":487},{"style":124},[488],{"type":20,"value":489},"server",{"type":14,"tag":117,"props":491,"children":492},{"style":130},[493],{"type":20,"value":213},{"type":14,"tag":117,"props":495,"children":497},{"class":119,"line":496},22,[498],{"type":14,"tag":117,"props":499,"children":500},{"style":369},[501],{"type":20,"value":502},"    #listen 80 default_server;\n",{"type":14,"tag":117,"props":504,"children":506},{"class":119,"line":505},23,[507],{"type":14,"tag":117,"props":508,"children":509},{"style":369},[510],{"type":20,"value":511},"    #listen [::]:80 default_server;\n",{"type":14,"tag":117,"props":513,"children":515},{"class":119,"line":514},24,[516,521,526],{"type":14,"tag":117,"props":517,"children":518},{"style":124},[519],{"type":20,"value":520},"    listen ",{"type":14,"tag":117,"props":522,"children":523},{"style":130},[524],{"type":20,"value":525},"443 ssl",{"type":14,"tag":117,"props":527,"children":528},{"style":136},[529],{"type":20,"value":139},{"type":14,"tag":117,"props":531,"children":533},{"class":119,"line":532},25,[534,538,543],{"type":14,"tag":117,"props":535,"children":536},{"style":124},[537],{"type":20,"value":520},{"type":14,"tag":117,"props":539,"children":540},{"style":130},[541],{"type":20,"value":542},"[::]:443 ssl",{"type":14,"tag":117,"props":544,"children":545},{"style":136},[546],{"type":20,"value":139},{"type":14,"tag":117,"props":548,"children":550},{"class":119,"line":549},26,[551,556,561],{"type":14,"tag":117,"props":552,"children":553},{"style":124},[554],{"type":20,"value":555},"    server_name ",{"type":14,"tag":117,"props":557,"children":558},{"style":130},[559],{"type":20,"value":560},"yourmainserver.com",{"type":14,"tag":117,"props":562,"children":563},{"style":136},[564],{"type":20,"value":139},{"type":14,"tag":117,"props":566,"children":568},{"class":119,"line":567},27,[569,574,579],{"type":14,"tag":117,"props":570,"children":571},{"style":124},[572],{"type":20,"value":573},"    ssl_certificate ",{"type":14,"tag":117,"props":575,"children":576},{"style":130},[577],{"type":20,"value":578},"/etc/openresty/default.pem",{"type":14,"tag":117,"props":580,"children":581},{"style":136},[582],{"type":20,"value":139},{"type":14,"tag":117,"props":584,"children":586},{"class":119,"line":585},28,[587,592,597],{"type":14,"tag":117,"props":588,"children":589},{"style":124},[590],{"type":20,"value":591},"    ssl_certificate_key ",{"type":14,"tag":117,"props":593,"children":594},{"style":130},[595],{"type":20,"value":596},"/etc/openresty/default.key",{"type":14,"tag":117,"props":598,"children":599},{"style":136},[600],{"type":20,"value":139},{"type":14,"tag":117,"props":602,"children":604},{"class":119,"line":603},29,[605,610],{"type":14,"tag":117,"props":606,"children":607},{"style":124},[608],{"type":20,"value":609},"    ssl_certificate_by_lua_block",{"type":14,"tag":117,"props":611,"children":612},{"style":130},[613],{"type":20,"value":213},{"type":14,"tag":117,"props":615,"children":617},{"class":119,"line":616},30,[618,623,627,631,635,640],{"type":14,"tag":117,"props":619,"children":620},{"style":220},[621],{"type":20,"value":622},"        require",{"type":14,"tag":117,"props":624,"children":625},{"style":130},[626],{"type":20,"value":228},{"type":14,"tag":117,"props":628,"children":629},{"style":231},[630],{"type":20,"value":234},{"type":14,"tag":117,"props":632,"children":633},{"style":130},[634],{"type":20,"value":239},{"type":14,"tag":117,"props":636,"children":637},{"style":220},[638],{"type":20,"value":639},"ssl_certificate",{"type":14,"tag":117,"props":641,"children":642},{"style":130},[643],{"type":20,"value":464},{"type":14,"tag":117,"props":645,"children":647},{"class":119,"line":646},31,[648],{"type":14,"tag":117,"props":649,"children":650},{"style":130},[651],{"type":20,"value":652},"    } \n",{"type":14,"tag":117,"props":654,"children":656},{"class":119,"line":655},32,[657,662],{"type":14,"tag":117,"props":658,"children":659},{"style":124},[660],{"type":20,"value":661},"    location",{"type":14,"tag":117,"props":663,"children":664},{"style":130},[665],{"type":20,"value":666}," / {\n",{"type":14,"tag":117,"props":668,"children":670},{"class":119,"line":669},33,[671,676],{"type":14,"tag":117,"props":672,"children":673},{"style":124},[674],{"type":20,"value":675},"        access_by_lua_block",{"type":14,"tag":117,"props":677,"children":678},{"style":130},[679],{"type":20,"value":213},{"type":14,"tag":117,"props":681,"children":683},{"class":119,"line":682},34,[684,689,694,698,703,708,712,717,722,727,732],{"type":14,"tag":117,"props":685,"children":686},{"style":124},[687],{"type":20,"value":688},"            local",{"type":14,"tag":117,"props":690,"children":691},{"style":130},[692],{"type":20,"value":693}," res ",{"type":14,"tag":117,"props":695,"children":696},{"style":261},[697],{"type":20,"value":264},{"type":14,"tag":117,"props":699,"children":700},{"style":130},[701],{"type":20,"value":702}," ngx.location.",{"type":14,"tag":117,"props":704,"children":705},{"style":220},[706],{"type":20,"value":707},"capture",{"type":14,"tag":117,"props":709,"children":710},{"style":130},[711],{"type":20,"value":228},{"type":14,"tag":117,"props":713,"children":714},{"style":231},[715],{"type":20,"value":716},"\"/domainCheck/?domain=\" ",{"type":14,"tag":117,"props":718,"children":719},{"style":261},[720],{"type":20,"value":721},"..",{"type":14,"tag":117,"props":723,"children":724},{"style":130},[725],{"type":20,"value":726}," ngx.",{"type":14,"tag":117,"props":728,"children":729},{"style":220},[730],{"type":20,"value":731},"escape_uri",{"type":14,"tag":117,"props":733,"children":734},{"style":130},[735],{"type":20,"value":736},"(ngx.var.host))\n",{"type":14,"tag":117,"props":738,"children":740},{"class":119,"line":739},35,[741,746,751,756,761],{"type":14,"tag":117,"props":742,"children":743},{"style":124},[744],{"type":20,"value":745},"            if",{"type":14,"tag":117,"props":747,"children":748},{"style":130},[749],{"type":20,"value":750}," res.status ",{"type":14,"tag":117,"props":752,"children":753},{"style":261},[754],{"type":20,"value":755},"~=",{"type":14,"tag":117,"props":757,"children":758},{"style":156},[759],{"type":20,"value":760}," 200",{"type":14,"tag":117,"props":762,"children":763},{"style":124},[764],{"type":20,"value":765}," then\n",{"type":14,"tag":117,"props":767,"children":769},{"class":119,"line":768},36,[770,775,780,785,790],{"type":14,"tag":117,"props":771,"children":772},{"style":130},[773],{"type":20,"value":774},"                ngx.",{"type":14,"tag":117,"props":776,"children":777},{"style":220},[778],{"type":20,"value":779},"log",{"type":14,"tag":117,"props":781,"children":782},{"style":130},[783],{"type":20,"value":784},"(ngx.WARN, ",{"type":14,"tag":117,"props":786,"children":787},{"style":231},[788],{"type":20,"value":789},"\"Domain not allowed: \"",{"type":14,"tag":117,"props":791,"children":792},{"style":130},[793],{"type":20,"value":794},", ngx.var.host)\n",{"type":14,"tag":117,"props":796,"children":798},{"class":119,"line":797},37,[799,804,808,813],{"type":14,"tag":117,"props":800,"children":801},{"style":124},[802],{"type":20,"value":803},"                return",{"type":14,"tag":117,"props":805,"children":806},{"style":130},[807],{"type":20,"value":726},{"type":14,"tag":117,"props":809,"children":810},{"style":220},[811],{"type":20,"value":812},"exit",{"type":14,"tag":117,"props":814,"children":815},{"style":130},[816],{"type":20,"value":817},"(ngx.HTTP_FORBIDDEN)\n",{"type":14,"tag":117,"props":819,"children":821},{"class":119,"line":820},38,[822],{"type":14,"tag":117,"props":823,"children":824},{"style":124},[825],{"type":20,"value":826},"            end\n",{"type":14,"tag":117,"props":828,"children":830},{"class":119,"line":829},39,[831],{"type":14,"tag":117,"props":832,"children":833},{"style":130},[834],{"type":20,"value":835},"        }\n",{"type":14,"tag":117,"props":837,"children":839},{"class":119,"line":838},40,[840,845,850],{"type":14,"tag":117,"props":841,"children":842},{"style":124},[843],{"type":20,"value":844},"        proxy_set_header ",{"type":14,"tag":117,"props":846,"children":847},{"style":130},[848],{"type":20,"value":849},"Upgrade $http_upgrade",{"type":14,"tag":117,"props":851,"children":852},{"style":136},[853],{"type":20,"value":139},{"type":14,"tag":117,"props":855,"children":857},{"class":119,"line":856},41,[858,862,867,872],{"type":14,"tag":117,"props":859,"children":860},{"style":124},[861],{"type":20,"value":844},{"type":14,"tag":117,"props":863,"children":864},{"style":130},[865],{"type":20,"value":866},"Connection ",{"type":14,"tag":117,"props":868,"children":869},{"style":231},[870],{"type":20,"value":871},"'Upgrade'",{"type":14,"tag":117,"props":873,"children":874},{"style":136},[875],{"type":20,"value":139},{"type":14,"tag":117,"props":877,"children":879},{"class":119,"line":878},42,[880,885,890],{"type":14,"tag":117,"props":881,"children":882},{"style":124},[883],{"type":20,"value":884},"        proxy_connect_timeout ",{"type":14,"tag":117,"props":886,"children":887},{"style":130},[888],{"type":20,"value":889},"10",{"type":14,"tag":117,"props":891,"children":892},{"style":136},[893],{"type":20,"value":139},{"type":14,"tag":117,"props":895,"children":897},{"class":119,"line":896},43,[898,903,908],{"type":14,"tag":117,"props":899,"children":900},{"style":124},[901],{"type":20,"value":902},"        proxy_send_timeout ",{"type":14,"tag":117,"props":904,"children":905},{"style":130},[906],{"type":20,"value":907},"90",{"type":14,"tag":117,"props":909,"children":910},{"style":136},[911],{"type":20,"value":139},{"type":14,"tag":117,"props":913,"children":915},{"class":119,"line":914},44,[916,921,925],{"type":14,"tag":117,"props":917,"children":918},{"style":124},[919],{"type":20,"value":920},"        proxy_read_timeout ",{"type":14,"tag":117,"props":922,"children":923},{"style":130},[924],{"type":20,"value":907},{"type":14,"tag":117,"props":926,"children":927},{"style":136},[928],{"type":20,"value":139},{"type":14,"tag":117,"props":930,"children":932},{"class":119,"line":931},45,[933,938,943],{"type":14,"tag":117,"props":934,"children":935},{"style":124},[936],{"type":20,"value":937},"        proxy_buffer_size ",{"type":14,"tag":117,"props":939,"children":940},{"style":130},[941],{"type":20,"value":942},"128k",{"type":14,"tag":117,"props":944,"children":945},{"style":136},[946],{"type":20,"value":139},{"type":14,"tag":117,"props":948,"children":950},{"class":119,"line":949},46,[951,956,961,966],{"type":14,"tag":117,"props":952,"children":953},{"style":124},[954],{"type":20,"value":955},"        proxy_buffers ",{"type":14,"tag":117,"props":957,"children":958},{"style":130},[959],{"type":20,"value":960},"4 ",{"type":14,"tag":117,"props":962,"children":963},{"style":156},[964],{"type":20,"value":965},"256k",{"type":14,"tag":117,"props":967,"children":968},{"style":136},[969],{"type":20,"value":139},{"type":14,"tag":117,"props":971,"children":973},{"class":119,"line":972},47,[974,979,983],{"type":14,"tag":117,"props":975,"children":976},{"style":124},[977],{"type":20,"value":978},"        proxy_busy_buffers_size ",{"type":14,"tag":117,"props":980,"children":981},{"style":130},[982],{"type":20,"value":965},{"type":14,"tag":117,"props":984,"children":985},{"style":136},[986],{"type":20,"value":139},{"type":14,"tag":117,"props":988,"children":990},{"class":119,"line":989},48,[991,996,1000],{"type":14,"tag":117,"props":992,"children":993},{"style":124},[994],{"type":20,"value":995},"        proxy_temp_file_write_size ",{"type":14,"tag":117,"props":997,"children":998},{"style":130},[999],{"type":20,"value":965},{"type":14,"tag":117,"props":1001,"children":1002},{"style":136},[1003],{"type":20,"value":139},{"type":14,"tag":117,"props":1005,"children":1007},{"class":119,"line":1006},49,[1008,1013,1018,1023],{"type":14,"tag":117,"props":1009,"children":1010},{"style":124},[1011],{"type":20,"value":1012},"        proxy_pass ",{"type":14,"tag":117,"props":1014,"children":1015},{"style":130},[1016],{"type":20,"value":1017},"http://localhost:9292",{"type":14,"tag":117,"props":1019,"children":1020},{"style":136},[1021],{"type":20,"value":1022},";",{"type":14,"tag":117,"props":1024,"children":1025},{"style":369},[1026],{"type":20,"value":1027}," # Your actual website (ex: http://localhost:3000)\n",{"type":14,"tag":117,"props":1029,"children":1031},{"class":119,"line":1030},50,[1032],{"type":14,"tag":117,"props":1033,"children":1034},{"style":130},[1035],{"type":20,"value":1036},"    }\n",{"type":14,"tag":117,"props":1038,"children":1040},{"class":119,"line":1039},51,[1041,1045],{"type":14,"tag":117,"props":1042,"children":1043},{"style":124},[1044],{"type":20,"value":661},{"type":14,"tag":117,"props":1046,"children":1047},{"style":130},[1048],{"type":20,"value":1049}," /.well-known {\n",{"type":14,"tag":117,"props":1051,"children":1053},{"class":119,"line":1052},52,[1054,1058],{"type":14,"tag":117,"props":1055,"children":1056},{"style":124},[1057],{"type":20,"value":675},{"type":14,"tag":117,"props":1059,"children":1060},{"style":130},[1061],{"type":20,"value":213},{"type":14,"tag":117,"props":1063,"children":1065},{"class":119,"line":1064},53,[1066,1070,1074,1078,1082,1086,1090,1094,1098,1102,1106],{"type":14,"tag":117,"props":1067,"children":1068},{"style":124},[1069],{"type":20,"value":688},{"type":14,"tag":117,"props":1071,"children":1072},{"style":130},[1073],{"type":20,"value":693},{"type":14,"tag":117,"props":1075,"children":1076},{"style":261},[1077],{"type":20,"value":264},{"type":14,"tag":117,"props":1079,"children":1080},{"style":130},[1081],{"type":20,"value":702},{"type":14,"tag":117,"props":1083,"children":1084},{"style":220},[1085],{"type":20,"value":707},{"type":14,"tag":117,"props":1087,"children":1088},{"style":130},[1089],{"type":20,"value":228},{"type":14,"tag":117,"props":1091,"children":1092},{"style":231},[1093],{"type":20,"value":716},{"type":14,"tag":117,"props":1095,"children":1096},{"style":261},[1097],{"type":20,"value":721},{"type":14,"tag":117,"props":1099,"children":1100},{"style":130},[1101],{"type":20,"value":726},{"type":14,"tag":117,"props":1103,"children":1104},{"style":220},[1105],{"type":20,"value":731},{"type":14,"tag":117,"props":1107,"children":1108},{"style":130},[1109],{"type":20,"value":736},{"type":14,"tag":117,"props":1111,"children":1113},{"class":119,"line":1112},54,[1114,1118,1122,1126,1130],{"type":14,"tag":117,"props":1115,"children":1116},{"style":124},[1117],{"type":20,"value":745},{"type":14,"tag":117,"props":1119,"children":1120},{"style":130},[1121],{"type":20,"value":750},{"type":14,"tag":117,"props":1123,"children":1124},{"style":261},[1125],{"type":20,"value":755},{"type":14,"tag":117,"props":1127,"children":1128},{"style":156},[1129],{"type":20,"value":760},{"type":14,"tag":117,"props":1131,"children":1132},{"style":124},[1133],{"type":20,"value":765},{"type":14,"tag":117,"props":1135,"children":1137},{"class":119,"line":1136},55,[1138,1142,1146,1150,1154],{"type":14,"tag":117,"props":1139,"children":1140},{"style":130},[1141],{"type":20,"value":774},{"type":14,"tag":117,"props":1143,"children":1144},{"style":220},[1145],{"type":20,"value":779},{"type":14,"tag":117,"props":1147,"children":1148},{"style":130},[1149],{"type":20,"value":784},{"type":14,"tag":117,"props":1151,"children":1152},{"style":231},[1153],{"type":20,"value":789},{"type":14,"tag":117,"props":1155,"children":1156},{"style":130},[1157],{"type":20,"value":794},{"type":14,"tag":117,"props":1159,"children":1161},{"class":119,"line":1160},56,[1162,1166,1170,1174],{"type":14,"tag":117,"props":1163,"children":1164},{"style":124},[1165],{"type":20,"value":803},{"type":14,"tag":117,"props":1167,"children":1168},{"style":130},[1169],{"type":20,"value":726},{"type":14,"tag":117,"props":1171,"children":1172},{"style":220},[1173],{"type":20,"value":812},{"type":14,"tag":117,"props":1175,"children":1176},{"style":130},[1177],{"type":20,"value":817},{"type":14,"tag":117,"props":1179,"children":1181},{"class":119,"line":1180},57,[1182],{"type":14,"tag":117,"props":1183,"children":1184},{"style":124},[1185],{"type":20,"value":826},{"type":14,"tag":117,"props":1187,"children":1189},{"class":119,"line":1188},58,[1190],{"type":14,"tag":117,"props":1191,"children":1192},{"style":130},[1193],{"type":20,"value":835},{"type":14,"tag":117,"props":1195,"children":1197},{"class":119,"line":1196},59,[1198,1203],{"type":14,"tag":117,"props":1199,"children":1200},{"style":124},[1201],{"type":20,"value":1202},"        content_by_lua_block",{"type":14,"tag":117,"props":1204,"children":1205},{"style":130},[1206],{"type":20,"value":213},{"type":14,"tag":117,"props":1208,"children":1210},{"class":119,"line":1209},60,[1211,1216,1220,1224,1228,1233],{"type":14,"tag":117,"props":1212,"children":1213},{"style":220},[1214],{"type":20,"value":1215},"            require",{"type":14,"tag":117,"props":1217,"children":1218},{"style":130},[1219],{"type":20,"value":228},{"type":14,"tag":117,"props":1221,"children":1222},{"style":231},[1223],{"type":20,"value":234},{"type":14,"tag":117,"props":1225,"children":1226},{"style":130},[1227],{"type":20,"value":239},{"type":14,"tag":117,"props":1229,"children":1230},{"style":220},[1231],{"type":20,"value":1232},"serve_http_challenge",{"type":14,"tag":117,"props":1234,"children":1235},{"style":130},[1236],{"type":20,"value":464},{"type":14,"tag":117,"props":1238,"children":1240},{"class":119,"line":1239},61,[1241],{"type":14,"tag":117,"props":1242,"children":1243},{"style":130},[1244],{"type":20,"value":835},{"type":14,"tag":117,"props":1246,"children":1248},{"class":119,"line":1247},62,[1249],{"type":14,"tag":117,"props":1250,"children":1251},{"style":130},[1252],{"type":20,"value":1036},{"type":14,"tag":117,"props":1254,"children":1256},{"class":119,"line":1255},63,[1257,1261],{"type":14,"tag":117,"props":1258,"children":1259},{"style":124},[1260],{"type":20,"value":661},{"type":14,"tag":117,"props":1262,"children":1263},{"style":130},[1264],{"type":20,"value":1265}," /domainCheck {\n",{"type":14,"tag":117,"props":1267,"children":1269},{"class":119,"line":1268},64,[1270,1275],{"type":14,"tag":117,"props":1271,"children":1272},{"style":124},[1273],{"type":20,"value":1274},"        internal",{"type":14,"tag":117,"props":1276,"children":1277},{"style":136},[1278],{"type":20,"value":139},{"type":14,"tag":117,"props":1280,"children":1282},{"class":119,"line":1281},65,[1283,1287,1292,1296],{"type":14,"tag":117,"props":1284,"children":1285},{"style":124},[1286],{"type":20,"value":1012},{"type":14,"tag":117,"props":1288,"children":1289},{"style":130},[1290],{"type":20,"value":1291},"http://localhost:9292/domainCheck",{"type":14,"tag":117,"props":1293,"children":1294},{"style":136},[1295],{"type":20,"value":1022},{"type":14,"tag":117,"props":1297,"children":1298},{"style":369},[1299],{"type":20,"value":1300},"  # Adjust the URL if needed\n",{"type":14,"tag":117,"props":1302,"children":1304},{"class":119,"line":1303},66,[1305,1309,1314],{"type":14,"tag":117,"props":1306,"children":1307},{"style":124},[1308],{"type":20,"value":844},{"type":14,"tag":117,"props":1310,"children":1311},{"style":130},[1312],{"type":20,"value":1313},"Host $host",{"type":14,"tag":117,"props":1315,"children":1316},{"style":136},[1317],{"type":20,"value":139},{"type":14,"tag":117,"props":1319,"children":1321},{"class":119,"line":1320},67,[1322,1326,1331],{"type":14,"tag":117,"props":1323,"children":1324},{"style":124},[1325],{"type":20,"value":844},{"type":14,"tag":117,"props":1327,"children":1328},{"style":130},[1329],{"type":20,"value":1330},"X-Real-IP $remote_addr",{"type":14,"tag":117,"props":1332,"children":1333},{"style":136},[1334],{"type":20,"value":139},{"type":14,"tag":117,"props":1336,"children":1338},{"class":119,"line":1337},68,[1339,1343,1348],{"type":14,"tag":117,"props":1340,"children":1341},{"style":124},[1342],{"type":20,"value":844},{"type":14,"tag":117,"props":1344,"children":1345},{"style":130},[1346],{"type":20,"value":1347},"X-Forwarded-For $proxy_add_x_forwarded_for",{"type":14,"tag":117,"props":1349,"children":1350},{"style":136},[1351],{"type":20,"value":139},{"type":14,"tag":117,"props":1353,"children":1355},{"class":119,"line":1354},69,[1356,1360,1365],{"type":14,"tag":117,"props":1357,"children":1358},{"style":124},[1359],{"type":20,"value":844},{"type":14,"tag":117,"props":1361,"children":1362},{"style":130},[1363],{"type":20,"value":1364},"X-Forwarded-Proto $scheme",{"type":14,"tag":117,"props":1366,"children":1367},{"style":136},[1368],{"type":20,"value":139},{"type":14,"tag":117,"props":1370,"children":1372},{"class":119,"line":1371},70,[1373],{"type":14,"tag":117,"props":1374,"children":1375},{"style":130},[1376],{"type":20,"value":1036},{"type":14,"tag":117,"props":1378,"children":1380},{"class":119,"line":1379},71,[1381],{"type":14,"tag":117,"props":1382,"children":1383},{"style":130},[1384],{"type":20,"value":411},{"type":14,"tag":26,"props":1386,"children":1388},{"id":1387},"explanation",[1389],{"type":20,"value":1390},"Explanation",{"type":14,"tag":33,"props":1392,"children":1393},{},[1394],{"type":20,"value":1395},"This configuration is a bit complex, but I'll try to explain it as best as I can.",{"type":14,"tag":45,"props":1397,"children":1398},{},[1399,1434,1487,1498],{"type":14,"tag":49,"props":1400,"children":1401},{},[1402,1404,1411],{"type":20,"value":1403},"The following directives were copied and pasted from the ",{"type":14,"tag":95,"props":1405,"children":1408},{"href":1406,"rel":1407},"https://github.com/fffonion/lua-resty-acme",[99],[1409],{"type":20,"value":1410},"lua-resty-acme repo",{"type":14,"tag":45,"props":1412,"children":1413},{},[1414,1419,1424,1429],{"type":14,"tag":49,"props":1415,"children":1416},{},[1417],{"type":20,"value":1418},"resolver: This is the DNS resolver used to resolve the domain.",{"type":14,"tag":49,"props":1420,"children":1421},{},[1422],{"type":20,"value":1423},"lua_shared_dict: This is used to store the certificates.",{"type":14,"tag":49,"props":1425,"children":1426},{},[1427],{"type":20,"value":1428},"lua_ssl_trusted_certificate: This is used to verify the Let's Encrypt API.",{"type":14,"tag":49,"props":1430,"children":1431},{},[1432],{"type":20,"value":1433},"lua_ssl_verify_depth: This is used to verify the Let's Encrypt API.",{"type":14,"tag":49,"props":1435,"children":1436},{},[1437,1439,1444,1446],{"type":20,"value":1438},"The ",{"type":14,"tag":113,"props":1440,"children":1442},{"className":1441},[],[1443],{"type":20,"value":208},{"type":20,"value":1445}," is used to initialize the Let's Encrypt API. This is where you can set the email, domain whitelist, and other settings.",{"type":14,"tag":45,"props":1447,"children":1448},{},[1449,1454,1459,1464,1477,1482],{"type":14,"tag":49,"props":1450,"children":1451},{},[1452],{"type":20,"value":1453},"tos_accepted: This is used to accept the Let's Encrypt TOS.",{"type":14,"tag":49,"props":1455,"children":1456},{},[1457],{"type":20,"value":1458},"account_key_path: This is the path to your account key.",{"type":14,"tag":49,"props":1460,"children":1461},{},[1462],{"type":20,"value":1463},"account_email: This is the email used to register the account.",{"type":14,"tag":49,"props":1465,"children":1466},{},[1467,1469,1475],{"type":20,"value":1468},"domain_whitelist: This is the list of domains that are allowed (set to nil as we will check this in the ",{"type":14,"tag":113,"props":1470,"children":1472},{"className":1471},[],[1473],{"type":20,"value":1474},"location /",{"type":20,"value":1476}," block).",{"type":14,"tag":49,"props":1478,"children":1479},{},[1480],{"type":20,"value":1481},"blocking: This is used to block the request until the certificate is generated. This could be set to false, but I felt like it was better to immediatley use the generated SSL certificate instead of using the fallbacks.",{"type":14,"tag":49,"props":1483,"children":1484},{},[1485],{"type":20,"value":1486},"staging: This is used to use the Let's Encrypt staging API. This is useful for testing and should be removed in production.",{"type":14,"tag":49,"props":1488,"children":1489},{},[1490,1491,1496],{"type":20,"value":1438},{"type":14,"tag":113,"props":1492,"children":1494},{"className":1493},[],[1495],{"type":20,"value":430},{"type":20,"value":1497}," is used to initialize the worker. This is where the certificate is generated.",{"type":14,"tag":49,"props":1499,"children":1500},{},[1501,1502,1507,1509],{"type":20,"value":1438},{"type":14,"tag":113,"props":1503,"children":1505},{"className":1504},[],[1506],{"type":20,"value":489},{"type":20,"value":1508}," block is where the actual server configuration is. This is where the domain is checked and the ACME http challenge is served.",{"type":14,"tag":45,"props":1510,"children":1511},{},[1512,1524,1536,1555,1567,1615,1666],{"type":14,"tag":49,"props":1513,"children":1514},{},[1515,1516,1522],{"type":20,"value":1438},{"type":14,"tag":113,"props":1517,"children":1519},{"className":1518},[],[1520],{"type":20,"value":1521},"listen",{"type":20,"value":1523}," directives are used to listen on port 443 and 80.",{"type":14,"tag":49,"props":1525,"children":1526},{},[1527,1528,1534],{"type":20,"value":1438},{"type":14,"tag":113,"props":1529,"children":1531},{"className":1530},[],[1532],{"type":20,"value":1533},"server_name",{"type":20,"value":1535}," directive is used to specify the main server name.",{"type":14,"tag":49,"props":1537,"children":1538},{},[1539,1540,1545,1547,1553],{"type":20,"value":1438},{"type":14,"tag":113,"props":1541,"children":1543},{"className":1542},[],[1544],{"type":20,"value":639},{"type":20,"value":1546}," and ",{"type":14,"tag":113,"props":1548,"children":1550},{"className":1549},[],[1551],{"type":20,"value":1552},"ssl_certificate_key",{"type":20,"value":1554}," directives are used to specify the default certificate and key. This is used to serve the default certificate until the certificate is generated.",{"type":14,"tag":49,"props":1556,"children":1557},{},[1558,1559,1565],{"type":20,"value":1438},{"type":14,"tag":113,"props":1560,"children":1562},{"className":1561},[],[1563],{"type":20,"value":1564},"ssl_certificate_by_lua_block",{"type":20,"value":1566}," is used to generate the SSL certificate.",{"type":14,"tag":49,"props":1568,"children":1569},{},[1570,1571,1576,1578],{"type":20,"value":1438},{"type":14,"tag":113,"props":1572,"children":1574},{"className":1573},[],[1575],{"type":20,"value":1474},{"type":20,"value":1577}," block is used to check if the domain is allowed. If it is not, it will return a 403.\n",{"type":14,"tag":45,"props":1579,"children":1580},{},[1581],{"type":14,"tag":49,"props":1582,"children":1583},{},[1584,1585,1591,1593],{"type":20,"value":1438},{"type":14,"tag":113,"props":1586,"children":1588},{"className":1587},[],[1589],{"type":20,"value":1590},"access_by_lua_block",{"type":20,"value":1592}," is used to check if the domain is allowed.\n",{"type":14,"tag":1594,"props":1595,"children":1596},"ol",{},[1597,1610],{"type":14,"tag":49,"props":1598,"children":1599},{},[1600,1602,1608],{"type":20,"value":1601},"We first capture the response from the ",{"type":14,"tag":113,"props":1603,"children":1605},{"className":1604},[],[1606],{"type":20,"value":1607},"/domainCheck",{"type":20,"value":1609}," location.",{"type":14,"tag":49,"props":1611,"children":1612},{},[1613],{"type":20,"value":1614},"If the status is not 200, we log a warning and return a 403.",{"type":14,"tag":49,"props":1616,"children":1617},{},[1618,1619,1625,1627],{"type":20,"value":1438},{"type":14,"tag":113,"props":1620,"children":1622},{"className":1621},[],[1623],{"type":20,"value":1624},"location /domainCheck",{"type":20,"value":1626}," block is used to check if the domain is allowed.\n",{"type":14,"tag":45,"props":1628,"children":1629},{},[1630,1642,1654],{"type":14,"tag":49,"props":1631,"children":1632},{},[1633,1634,1640],{"type":20,"value":1438},{"type":14,"tag":113,"props":1635,"children":1637},{"className":1636},[],[1638],{"type":20,"value":1639},"internal",{"type":20,"value":1641}," directive is used to prevent direct access to the location.",{"type":14,"tag":49,"props":1643,"children":1644},{},[1645,1646,1652],{"type":20,"value":1438},{"type":14,"tag":113,"props":1647,"children":1649},{"className":1648},[],[1650],{"type":20,"value":1651},"proxy_pass",{"type":20,"value":1653}," directive is used to pass the request to our actual http server that verifies the domain against a database or list. If it is allowed, it sends a 200 status code.",{"type":14,"tag":49,"props":1655,"children":1656},{},[1657,1658,1664],{"type":20,"value":1438},{"type":14,"tag":113,"props":1659,"children":1661},{"className":1660},[],[1662],{"type":20,"value":1663},"proxy_set_header",{"type":20,"value":1665}," directives are used to set the headers.",{"type":14,"tag":49,"props":1667,"children":1668},{},[1669,1670,1676,1678],{"type":20,"value":1438},{"type":14,"tag":113,"props":1671,"children":1673},{"className":1672},[],[1674],{"type":20,"value":1675},"location /.well-known",{"type":20,"value":1677}," block is used to serve the ACME http challenge.\n",{"type":14,"tag":45,"props":1679,"children":1680},{},[1681,1686],{"type":14,"tag":49,"props":1682,"children":1683},{},[1684],{"type":20,"value":1685},"We also check if the domain is allowed here as to not spam the Let's Encrypt API.",{"type":14,"tag":49,"props":1687,"children":1688},{},[1689,1690,1696],{"type":20,"value":1438},{"type":14,"tag":113,"props":1691,"children":1693},{"className":1692},[],[1694],{"type":20,"value":1695},"content_by_lua_block",{"type":20,"value":1697}," is used to serve the ACME http challenge.",{"type":14,"tag":26,"props":1699,"children":1701},{"id":1700},"how-i-figured-it-out",[1702],{"type":20,"value":1703},"How I figured it out",{"type":14,"tag":33,"props":1705,"children":1706},{},[1707,1709,1716,1718,1725,1727,1732],{"type":20,"value":1708},"I first started with the config provided by the ",{"type":14,"tag":95,"props":1710,"children":1713},{"href":1711,"rel":1712},"https://docs.titaniumnetwork.org/guides/nginx",[99],[1714],{"type":20,"value":1715},"TitaniumNetwork Docs",{"type":20,"value":1717},"\nThen I started looking at how to get the domain from the request and how to check if it was allowed.\nI was using normal NGINX, but I quickly realized that I needed to use Lua to get the domain and check if it was allowed.\nI then found the ",{"type":14,"tag":95,"props":1719,"children":1722},{"href":1720,"rel":1721},"https://github.com/auto-ssl/lua-resty-auto-ssl/",[99],[1723],{"type":20,"value":1724},"lua-resty-auto-ssl repo",{"type":20,"value":1726}," but quickly realized it was unmaintained and kept searching.\nThen I found the ",{"type":14,"tag":95,"props":1728,"children":1730},{"href":1406,"rel":1729},[99],[1731],{"type":20,"value":1410},{"type":20,"value":1733}," and started using that.\nThe rest was trial and error with a shit ton of Googling.",{"type":14,"tag":26,"props":1735,"children":1737},{"id":1736},"final-thoughts",[1738],{"type":20,"value":1739},"Final thoughts",{"type":14,"tag":33,"props":1741,"children":1742},{},[1743,1745],{"type":20,"value":1744},"This was a rather fun challenge, allowing me to learn crap tons of stuff about how NGINX and OpenResty works and had fun while doing so.\nThe repo providing a Discord bot, http server, database and this config is located ",{"type":14,"tag":95,"props":1746,"children":1749},{"href":1747,"rel":1748},"https://github.com/ruby-network/byod-bot",[99],[1750],{"type":20,"value":1751},"here",{"type":14,"tag":26,"props":1753,"children":1755},{"id":1754},"credits",[1756],{"type":20,"value":1757},"Credits:",{"type":14,"tag":45,"props":1759,"children":1760},{},[1761,1772,1784],{"type":14,"tag":49,"props":1762,"children":1763},{},[1764,1770],{"type":14,"tag":95,"props":1765,"children":1768},{"href":1766,"rel":1767},"https://docs.titaniumnetwork.org",[99],[1769],{"type":20,"value":1715},{"type":20,"value":1771}," for the base config.",{"type":14,"tag":49,"props":1773,"children":1774},{},[1775,1776,1782],{"type":20,"value":1438},{"type":14,"tag":95,"props":1777,"children":1779},{"href":1406,"rel":1778},[99],[1780],{"type":20,"value":1781},"lua resty acme repo",{"type":20,"value":1783}," for the auto ssl stuff.",{"type":14,"tag":49,"props":1785,"children":1786},{},[1787,1788,1795],{"type":20,"value":1438},{"type":14,"tag":95,"props":1789,"children":1792},{"href":1790,"rel":1791},"https://caddyserver.com/docs/automatic-https#on-demand-tls",[99],[1793],{"type":20,"value":1794},"On Demand TLS feature by Caddy",{"type":20,"value":1796}," which this was inspired by.",{"type":14,"tag":1798,"props":1799,"children":1800},"style",{},[1801],{"type":20,"value":1802},"html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}",{"title":7,"searchDepth":142,"depth":142,"links":1804},[1805,1806,1807,1808,1809,1810,1811,1812],{"id":28,"depth":142,"text":31},{"id":40,"depth":142,"text":43},{"id":74,"depth":142,"text":77},{"id":85,"depth":142,"text":88},{"id":1387,"depth":142,"text":1390},{"id":1700,"depth":142,"text":1703},{"id":1736,"depth":142,"text":1739},{"id":1754,"depth":142,"text":1757},"markdown","content:blog:nginx-byod.md","content","blog/nginx-byod.md","md",1714607854312]